# ๐ฏ **MASTER CONTEXT - ูุธุงู ุฅุฏุงุฑุฉ ูุญุงุฏุซุงุช ุตูุฏููุงุช ุฎูููุฉ**
## **ุงููุฑุฌุน ุงูุดุงูู ููุชูููุฐ (ุฎููู โ ุชููู)**

---

## ๐ **ุฌุฏูู ุงููุญุชููุงุช**
1. [ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุดุฑูุน](#1-ูุธุฑุฉ-ุนุงูุฉ)
2. [ุงุณุชุฑุงุชูุฌูุฉ ุงูุชูููุฐ (ูุฑุญูุชูู)](#2-ุงุณุชุฑุงุชูุฌูุฉ-ุงูุชูููุฐ)
3. [ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุงููุฉ](#3-ูุงุนุฏุฉ-ุงูุจูุงูุงุช)
4. [ุงูุณููุงุฑูููุงุช ุงูุชูุตูููุฉ](#4-ุงูุณููุงุฑูููุงุช)
5. [ุงูุนูููุงุช ูุงูู Queries](#5-ุงูุนูููุงุช-ูุงูqueries)
6. [ูุคุดุฑุงุช ุงูุฃุฏุงุก KPIs](#6-ูุคุดุฑุงุช-ุงูุฃุฏุงุก)
7. [ุงููุงุฌูุงุช ูุงูุดุงุดุงุช](#8-ุงููุงุฌูุงุช)

---

## ๐ข **1. ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุดุฑูุน**

### **ุงูุนููู:**
- **ุงูุงุณู:** ุตูุฏููุงุช ุฎูููุฉ
- **ุงููููุน:** ุงูููุตูุฑุฉ
- **ุนุฏุฏ ุงููุฑูุน:** 15 ูุฑุน
- **ุงููุดููุฉ:** ุงุณุชุฎุฏุงู ุฑูู ูุงุญุฏ ูู ุนุฏุฉ ููุธููู โ ุญุธุฑ ุงูุฑูู

### **ุงูุญู:**
ูุธุงู ุฅุฏุงุฑุฉ ูุญุงุฏุซุงุช ุฐูู ููุฒุน ุงููุญุงุฏุซุงุช ุชููุงุฆูุงู ุนูู ุงูููุธููู ุงููุชุงุญูู ูุน ุชุชุจุน ุงูุฃุฏุงุก.

### **ุงูุฃูุฏุงู ุงูุฑุฆูุณูุฉ:**
โ ุชูุฒูุน ุชููุงุฆู ูููุญุงุฏุซุงุช  
โ ุชุชุจุน ุฃุฏุงุก ุงูููุธููู (KPIs)  
โ ุฅุฏุงุฑุฉ ูุฑูุฒูุฉ  
โ ุชูุงุฑูุฑ ุชูุตูููุฉ  
โ Response Time < 3 ุฏูุงุฆู  

---

## ๐ **2. ุงุณุชุฑุงุชูุฌูุฉ ุงูุชูููุฐ (ูุฑุญูุชูู)**

### **๐ ุงููุฑุญูุฉ 1๏ธโฃ: ุฎููู ุนูู ุฎููู (MVP - 4 ุฃุณุงุจูุน)**

#### **ุงูุชูููุงุช:**
```
โ Backend: Django (Python)
โ Database: SQLite (ุฌุงูุฒ ููุงูุชูุงู ูู PostgreSQL/MySQL)
โ Frontend: HTML + CSS + JavaScript (Vanilla)
โ Real-time: Django Channels (WebSocket)
โ ุจุฏูู WhatsApp Business API
โ ุจุฏูู Integration ุฎุงุฑุฌู
```

#### **ููุงุฐุง SQLite ูู ุงูุจุฏุงูุฉุ**
- ุณูู ุงูุฅุนุฏุงุฏ (ูุง ูุญุชุงุฌ ุชุซุจูุช)
- ูุซุงูู ููุชุทููุฑ ูุงูุงุฎุชุจุงุฑ
- ููุณ ุงูู SQL ุชูุงูุงู
- ุงูุงูุชูุงู ูู PostgreSQL/MySQL ุณูู ุฌุฏุงู (ุชุบููุฑ ุณุทุฑ ูุงุญุฏ ูู settings.py)

#### **ุงููุฏู:**
- ุจูุงุก ูุธุงู ุฏุงุฎูู ูุงูู ูุฅุฏุงุฑุฉ ุงูุชุฐุงูุฑ
- ุงุฎุชุจุงุฑ ููุทู ุงูุชูุฒูุน ุงูุชููุงุฆู
- ุชุฏุฑูุจ ุงูููุธููู
- ุงูุชุฃูุฏ ูู ุตุญุฉ KPIs
- ูุญุงูุงุฉ ุงูุนูู ุงูุญูููู

#### **ููู ูุนูู:**
```
1. Admin ูุฏุฎู ุฑุณุงุฆู ุงูุนููุงุก ูุฏููุงู (ูุญุงูุงุฉ)
2. ุงููุธุงู ููุฒุน ุงูุชุฐุงูุฑ ุชููุงุฆูุงู
3. ุงูููุธููู ูุฑุฏูู ูู ุฎูุงู ุงููุงุฌูุฉ
4. ุงููุธุงู ูุญุณุจ KPIs ููุชุชุจุน ุงูุฃุฏุงุก
5. Admin ูุฑุงูุจ ูู ุดูุก ูู Dashboard
```

---

### **๐ ุงููุฑุญูุฉ 2๏ธโฃ: ุงูุฎููู ุงุชุญูู ูุชููู (Production - 17 ููู)**

#### **๐ ุงูุฌุฒุก ุงูุฃูู: WPPConnect Driver (8 ุฃูุงู)**

```
โ ุชุตููู Driver Pattern Architecture
   โโโ MessageDriver Interface
   โโโ DriverFactory
   โโโ ุชุญุฏูุซ Database Schema (provider + id_ext)

โ ุชุทุจูู WPPConnect Driver
   โโโ QR Code Scan
   โโโ Send/Receive Messages
   โโโ Webhook Handler

โ Redis Queue Setup
   โโโ Incoming Messages Queue
   โโโ Outgoing Messages Queue
   โโโ Worker Processes

โ ุฏูุฌ ูุน Core
   โโโ Incoming Message Handler
   โโโ Outgoing Message Handler
   โโโ WebSocket Notifications

โ ุงุฎุชุจุงุฑ ููุดุฑ
   โโโ Unit Tests
   โโโ Integration Tests
   โโโ Production Deployment
```

#### **โ๏ธ ุงูุฌุฒุก ุงูุซุงูู: Cloud API Driver (9 ุฃูุงู)**

```
โ ุฅุนุฏุงุฏ WhatsApp Business Cloud API
   โโโ ุชุณุฌูู ูู Meta Developer
   โโโ ุฅูุดุงุก WhatsApp Business Account
   โโโ ุงูุญุตูู ุนูู Access Token

โ ุชุทุจูู Cloud API Driver
   โโโ CloudAPIDriver Class
   โโโ Webhook Verification
   โโโ Message Parsing

โ Migration Strategy
   โโโ Data Migration Script
   โโโ Testing ูู ุจูุฆุฉ ุงูุชุทููุฑ
   โโโ Rollback Plan

โ ุงููุดุฑ ูุงููุฑุงูุจุฉ
   โโโ Production Migration
   โโโ Monitoring (24 ุณุงุนุฉ)
   โโโ Performance Tuning

โ ุงูุชุญููู ุงูููุงุฆู
   โโโ ุชุบููุฑ WHATSAPP_DRIVER=cloud_api ูู .env
   โโโ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
   โโโ ุฅููุงู WPPConnect (ุงุฎุชูุงุฑู)
```

#### **ุงูุฅุถุงูุงุช ุงูุฃุฎุฑู:**
```
โ Webhooks ูุงุณุชูุจุงู ุงูุฑุณุงุฆู ุชููุงุฆูุงู
โ ุฅุฑุณุงู ุงูุฑุฏูุฏ ุนุจุฑ WhatsApp API
โ ุฑุจุท ุงูุฑูู ุงูุญูููู
โ ุงูุชุดุบูู ุงููุจุงุดุฑ ูุน ุงูุนููุงุก
โ ุงูุงูุชูุงู ูู SQLite ุฅูู PostgreSQL/MySQL
```

#### **ุงูุชุบููุฑุงุช:**
| ูุจู (ุงููุฑุญูุฉ 1) | ุจุนุฏ (ุงููุฑุญูุฉ 2) |
|-----------------|-----------------|
| Django + SQLite | Django + PostgreSQL/MySQL |
| Admin ูุฏุฎู ุงูุฑุณุงุฆู ูุฏููุงู | ุงูุฑุณุงุฆู ุชุฃุชู ุชููุงุฆูุงู ูู WhatsApp |
| ุงูุฑุฏูุฏ ุฏุงุฎู ุงููุธุงู ููุท | ุงูุฑุฏูุฏ ุชุฑุณู ููุนููู ุนุจุฑ WhatsApp |
| ูุญุงูุงุฉ | ุชุดุบูู ุญูููู |

---

## ๐ **3. ุฏูุฑุฉ ุญูุงุฉ ุงูุชุฐูุฑุฉ (Ticket Lifecycle)**

### **ุงูุญุงูุงุช ุงูููููุฉ:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                             โ
โ  ๐ฉ ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู ุงูุนููู                                 โ
โ           โ                                                 โ
โ           โผ                                                 โ
โ     โโโโโโโโโโโโ                                            โ
โ     โ  OPEN    โ โ ุงูุชุฐูุฑุฉ ููุชูุญุฉ (ุงูููุธู ุงุณุชูููุง)        โ
โ     โโโโโโฌโโโโโโ                                            โ
โ          โ                                                  โ
โ          โโโโ (ุฅุฐุง ูุฑ 3 ุฏูุงุฆู ุจุฏูู ุฑุฏ)                     โ
โ          โ                                                  โ
โ          โผ                                                  โ
โ     โโโโโโโโโโโโ                                            โ
โ     โ DELAYED  โ โ ูุชุฃุฎุฑุฉ (ููุญุณุจ ููุช ุงูุชุฃุฎูุฑ)              โ
โ     โโโโโโฌโโโโโโ                                            โ
โ          โ                                                  โ
โ          โโโโ (ุนูุฏ ุฑุฏ ุงูููุธู)                              โ
โ          โ                                                  โ
โ          โผ                                                  โ
โ     โโโโโโโโโโโโ                                            โ
โ     โ  OPEN    โ โ ุชุฑุฌุน ููุชูุญุฉ (ูุน ุญุณุงุจ ุฏูุงุฆู ุงูุชุฃุฎูุฑ)    โ
โ     โโโโโโฌโโโโโโ                                            โ
โ          โ                                                  โ
โ          โโโโ (ุงูููุธู ูุถุบุท "ุฅููุงุก ุงููุญุงุฏุซุฉ")              โ
โ          โ                                                  โ
โ          โผ                                                  โ
โ     โโโโโโโโโโโโ                                            โ
โ     โ  CLOSED  โ โ ูุบููุฉ (ููุชููุฉ)                          โ
โ     โโโโโโโโโโโโ                                            โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### **ุงูููุงุนุฏ ุงููููุฉ:**

1. **ุนูุฏ ุงุณุชูุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ:**
   - ุงูุญุงูุฉ ุชุตุจุญ: `OPEN`
   - ูุจุฏุฃ Timer ุงูู 3 ุฏูุงุฆู

2. **ุฅุฐุง ูุฑ 3 ุฏูุงุฆู ุจุฏูู ุฑุฏ:**
   - ุงูุญุงูุฉ ุชุชุบูุฑ ุฅูู: `DELAYED`
   - ููุณุฌู ููุช ุจุฏุงูุฉ ุงูุชุฃุฎูุฑ
   - ููุญุณุจ ุนูู KPI ุงูููุธู

3. **ุนูุฏ ุฑุฏ ุงูููุธู ุจุนุฏ ุงูุชุฃุฎูุฑ:**
   - ุงูุญุงูุฉ ุชุฑุฌุน ุฅูู: `OPEN`
   - ููุญุณุจ ููุช ุงูุชุฃุฎูุฑ (ุจุงูุฏูุงุฆู)
   - ููุณุฌู ูู `agent_delay_events`
   - **ููู:** ุงูุชุฃุฎูุฑ ููุญุณุจ ุนูู ุงูููุธู ุญุชู ูู ุฑุฏ ุจุนุฏูุง

4. **ุนูุฏ ุฅููุงุก ุงููุญุงุฏุซุฉ:**
   - ุงูููุธู ูุถุบุท "ุฅููุงุก ุงููุญุงุฏุซุฉ"
   - ุงูุญุงูุฉ ุชุตุจุญ: `CLOSED`
   - ุชูุญุณุจ ูู KPIs

---

## ๐๏ธ **4. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุงููุฉ**

### **ููุณูุฉ ุงูุชุตููู:**
```
โ ุงุณุชุฎุฏุงู ุงูุฌุฏุงูู ุงูู 21 ูู digarms_flow.md
โ ุชุทุจูู ุงูุณููุงุฑูููุงุช ูู context_3.md
โ ุจูุงุก ุชุฏุฑูุฌู (ุงููุฑุญูุฉ 1 โ ุงููุฑุญูุฉ 2)
โ SQLite ูู ุงูุจุฏุงูุฉ โ PostgreSQL/MySQL ูุงุญูุงู
```

---

### **๐ GROUP 1: USER MANAGEMENT (3 ุฌุฏุงูู)**

#### **1. users**
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('admin', 'agent') NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    is_online BOOLEAN DEFAULT FALSE,
    last_login TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_role (role),
    INDEX idx_is_active (is_active),
    INDEX idx_is_online (is_online)
);
```

**ุงูุบุฑุถ:** ุชุฎุฒูู ุจูุงูุงุช ุงููุณุชุฎุฏููู (Admin + Agents)

**ุงูุนูุงูุงุช:**
- `1 User` โ `Many Tickets` (ูู agent ูุณุคูู)
- `1 User` โ `Many Messages` (ูู sender)

---

#### **2. agents**
```sql
CREATE TABLE agents (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL UNIQUE,
    max_capacity INT DEFAULT 15,
    current_active_tickets INT DEFAULT 0,
    is_online BOOLEAN DEFAULT FALSE,
    status ENUM('available', 'busy', 'offline', 'on_break') DEFAULT 'offline',
    total_messages_sent INT DEFAULT 0,
    total_messages_received INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_status (status),
    INDEX idx_is_online (is_online),
    INDEX idx_current_active_tickets (current_active_tickets)
);
```

**ุงูุบุฑุถ:** ุจูุงูุงุช ุงูู Agents (ุงูุณุนุฉุ ุงูุญุงูุฉุ ุงูุนุฏุงุฏุงุช)

**ุงูุนูุงูุงุช:**
- `1 Agent` โ `1 User` (One-to-One)
- `1 Agent` โ `Many Tickets`

---

#### **3. admins**
```sql
CREATE TABLE admins (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL UNIQUE,
    can_manage_agents BOOLEAN DEFAULT TRUE,
    can_manage_templates BOOLEAN DEFAULT TRUE,
    can_view_analytics BOOLEAN DEFAULT TRUE,
    can_edit_global_templates BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**ุงูุบุฑุถ:** ุตูุงุญูุงุช ุงูู Admins

---

### **๐ GROUP 2: CUSTOMER & CONTACT MANAGEMENT (3 ุฌุฏุงูู)**

#### **4. customers**
```sql
CREATE TABLE customers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    phone_number VARCHAR(20) UNIQUE NOT NULL,
    wa_id VARCHAR(50) UNIQUE NOT NULL,  -- WhatsApp ID
    name VARCHAR(100),
    email VARCHAR(100),
    notes TEXT,
    customer_type ENUM('regular', 'vip', 'sick', 'needs_visits') DEFAULT 'regular',
    is_blocked BOOLEAN DEFAULT FALSE,
    total_tickets_count INT DEFAULT 0,
    first_contact_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_contact_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_phone_number (phone_number),
    INDEX idx_wa_id (wa_id),
    INDEX idx_customer_type (customer_type),
    FULLTEXT INDEX idx_name (name)
);
```

**ุงูุบุฑุถ:** ุชุฎุฒูู ุจูุงูุงุช ุงูุนููุงุก

**ุงูุนูุงูุงุช:**
- `1 Customer` โ `Many Tickets`

---

#### **5. customer_tags**
```sql
CREATE TABLE customer_tags (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    tag VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    UNIQUE INDEX idx_customer_tag (customer_id, tag)
);
```

---

#### **6. customer_notes**
```sql
CREATE TABLE customer_notes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    created_by INT NOT NULL,
    note_text TEXT NOT NULL,
    is_important BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_customer_id (customer_id),
    INDEX idx_created_at (created_at)
);
```

---

### **๐ GROUP 3: TICKET MANAGEMENT (3 ุฌุฏุงูู)**

#### **7. tickets** โญ **ุงูููุจ**
```sql
CREATE TABLE tickets (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_number VARCHAR(20) UNIQUE NOT NULL,
    customer_id INT NOT NULL,
    assigned_agent_id INT,
    current_agent_id INT,

    -- ุงูุญุงูุงุช: open (ููุชูุญุฉ), delayed (ูุชุฃุฎุฑุฉ), closed (ูุบููุฉ)
    status ENUM('open', 'delayed', 'closed') DEFAULT 'open',

    category ENUM('medicine_order', 'complaint', 'consultation', 'follow_up', 'general') DEFAULT 'general',
    priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium',

    -- Delay Tracking
    is_delayed BOOLEAN DEFAULT FALSE,
    delay_started_at TIMESTAMP NULL,  -- ูุชู ุจุฏุฃ ุงูุชุฃุฎูุฑ
    total_delay_minutes INT DEFAULT 0,  -- ุฅุฌูุงูู ุฏูุงุฆู ุงูุชุฃุฎูุฑ
    delay_count INT DEFAULT 0,  -- ุนุฏุฏ ูุฑุงุช ุงูุชุฃุฎูุฑ

    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    first_response_at TIMESTAMP NULL,
    last_message_at TIMESTAMP NULL,
    last_customer_message_at TIMESTAMP NULL,
    last_agent_message_at TIMESTAMP NULL,
    closed_at TIMESTAMP NULL,
    
    -- Metrics
    response_time_seconds INT,
    handling_time_seconds INT,
    messages_count INT DEFAULT 0,
    
    -- Closure Info
    closed_by_user_id INT,
    closure_reason VARCHAR(255),
    
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_agent_id) REFERENCES agents(id) ON DELETE SET NULL,
    FOREIGN KEY (current_agent_id) REFERENCES agents(id) ON DELETE SET NULL,
    FOREIGN KEY (closed_by_user_id) REFERENCES users(id) ON DELETE SET NULL,
    
    INDEX idx_status (status),
    INDEX idx_assigned_agent_id (assigned_agent_id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_created_at (created_at),
    INDEX idx_is_delayed (is_delayed),
    INDEX idx_active_agent (assigned_agent_id, status)
);
```

**ุงูุบุฑุถ:** ุงูุฌุฏูู ุงูุฃุณุงุณู - ููุจ ุงููุธุงู

**ุงูุนูุงูุงุช:**
- `Many Tickets` โ `1 Customer`
- `Many Tickets` โ `1 Agent`
- `1 Ticket` โ `Many Messages`

---

#### **8. ticket_transfers_log**
```sql
CREATE TABLE ticket_transfers_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_id INT NOT NULL,
    from_agent_id INT,
    to_agent_id INT NOT NULL,
    transferred_by INT NOT NULL,  -- Admin who transferred
    reason VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (from_agent_id) REFERENCES agents(id) ON DELETE SET NULL,
    FOREIGN KEY (to_agent_id) REFERENCES agents(id) ON DELETE CASCADE,
    FOREIGN KEY (transferred_by) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_ticket_id (ticket_id),
    INDEX idx_created_at (created_at)
);
```

---

#### **9. ticket_states_log**
```sql
CREATE TABLE ticket_states_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_id INT NOT NULL,
    old_state VARCHAR(50),
    new_state VARCHAR(50) NOT NULL,
    changed_by INT,  -- NULL for automatic state changes
    reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_ticket_id (ticket_id),
    INDEX idx_created_at (created_at)
);
```

---

### **๐ GROUP 4: MESSAGES (3 ุฌุฏุงูู)**

#### **10. messages**
```sql
CREATE TABLE messages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_id INT NOT NULL,
    sender_id INT,  -- NULL if from customer
    sender_type ENUM('customer', 'agent', 'admin', 'system') NOT NULL,
    message_text TEXT,
    message_type ENUM('text', 'image', 'document', 'audio', 'video', 'file', 'interactive', 'template') DEFAULT 'text',
    media_url VARCHAR(500),
    mime_type VARCHAR(100),

    -- WhatsApp Integration (ุงููุฑุญูุฉ 2)
    whatsapp_message_id VARCHAR(100),
    whatsapp_status ENUM('sent', 'delivered', 'read', 'failed') DEFAULT 'sent',

    is_deleted BOOLEAN DEFAULT FALSE,
    is_forwarded BOOLEAN DEFAULT FALSE,
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE SET NULL,

    INDEX idx_ticket_id (ticket_id),
    INDEX idx_sender_type (sender_type),
    INDEX idx_created_at (created_at),
    INDEX idx_whatsapp_message_id (whatsapp_message_id),
    INDEX idx_is_read (is_read),  -- ููุจุญุซ ุงูุณุฑูุน ุนู ุบูุฑ ุงูููุฑูุกุฉ
    FULLTEXT INDEX idx_message_text (message_text)  -- ููุจุญุซ ูู ุงููุต (Full-Text Search)
);
```

---

#### **11. message_delivery_log**
```sql
CREATE TABLE message_delivery_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    message_id INT NOT NULL,
    delivery_status ENUM('pending', 'sent', 'delivered', 'read', 'failed') NOT NULL,
    error_message VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
    INDEX idx_message_id (message_id),
    INDEX idx_created_at (created_at)
);
```

---

#### **12. message_search_index**
```sql
CREATE TABLE message_search_index (
    id INT PRIMARY KEY AUTO_INCREMENT,
    message_id INT NOT NULL,
    customer_id INT NOT NULL,
    search_text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FULLTEXT INDEX idx_search_text (search_text),
    INDEX idx_customer_id (customer_id)
);
```

---

### **๐ GROUP 5: TEMPLATES & QUICK REPLIES (3 ุฌุฏุงูู)**

#### **13. global_templates**
```sql
CREATE TABLE global_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    created_by INT NOT NULL,
    updated_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES admins(id) ON DELETE CASCADE,
    FOREIGN KEY (updated_by) REFERENCES admins(id) ON DELETE SET NULL,
    INDEX idx_is_active (is_active),
    INDEX idx_category (category)
);
```

---

#### **14. agent_templates**
```sql
CREATE TABLE agent_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    agent_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    usage_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
    UNIQUE INDEX idx_agent_name (agent_id, name),
    INDEX idx_is_active (is_active)
);
```

---

#### **15. auto_reply_triggers**
```sql
CREATE TABLE auto_reply_triggers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trigger_keyword VARCHAR(100) NOT NULL,
    template_id INT,
    reply_text TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    trigger_type ENUM('keyword', 'category', 'greeting') DEFAULT 'keyword',
    created_by INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (template_id) REFERENCES global_templates(id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES admins(id) ON DELETE CASCADE,
    INDEX idx_is_active (is_active),
    INDEX idx_trigger_keyword (trigger_keyword)
);
```

---

### **๐ GROUP 6: DELAY TRACKING & MONITORING (2 ุฌุฏุงูู)**

#### **16. response_time_tracking**
```sql
CREATE TABLE response_time_tracking (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_id INT NOT NULL,
    agent_id INT,
    message_received_at TIMESTAMP NOT NULL,
    first_response_at TIMESTAMP,
    response_time_seconds INT,
    is_delayed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE SET NULL,
    INDEX idx_agent_id (agent_id),
    INDEX idx_is_delayed (is_delayed),
    INDEX idx_created_at (created_at)
);
```

---

#### **17. agent_delay_events**
```sql
CREATE TABLE agent_delay_events (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_id INT NOT NULL,
    agent_id INT NOT NULL,
    delay_start_time TIMESTAMP NOT NULL,
    delay_end_time TIMESTAMP,
    delay_duration_seconds INT,
    reason VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
    INDEX idx_agent_id (agent_id),
    INDEX idx_created_at (created_at)
);
```

---

### **๐ GROUP 7: KPI & PERFORMANCE METRICS (3 ุฌุฏุงูู)**

#### **18. agent_kpi**
```sql
CREATE TABLE agent_kpi (
    id INT PRIMARY KEY AUTO_INCREMENT,
    agent_id INT NOT NULL,
    kpi_date DATE NOT NULL,
    total_tickets INT DEFAULT 0,
    closed_tickets INT DEFAULT 0,
    avg_response_time_seconds INT,
    messages_sent INT DEFAULT 0,
    messages_received INT DEFAULT 0,
    delay_count INT DEFAULT 0,
    customer_satisfaction_score DECIMAL(3,2),
    first_response_rate DECIMAL(5,2),
    resolution_rate DECIMAL(5,2),
    overall_kpi_score DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
    UNIQUE INDEX idx_agent_date (agent_id, kpi_date),
    INDEX idx_kpi_date (kpi_date)
);
```

---

#### **19. agent_kpi_monthly**
```sql
CREATE TABLE agent_kpi_monthly (
    id INT PRIMARY KEY AUTO_INCREMENT,
    agent_id INT NOT NULL,
    month DATE NOT NULL,  -- First day of month
    total_tickets INT DEFAULT 0,
    closed_tickets INT DEFAULT 0,
    avg_response_time_seconds INT,
    messages_sent INT DEFAULT 0,
    messages_received INT DEFAULT 0,
    delay_count INT DEFAULT 0,
    avg_customer_satisfaction DECIMAL(3,2),
    overall_kpi_score DECIMAL(5,2),
    rank INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
    UNIQUE INDEX idx_agent_month (agent_id, month),
    INDEX idx_month (month)
);
```

---

#### **20. customer_satisfaction**
```sql
CREATE TABLE customer_satisfaction (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ticket_id INT NOT NULL,
    agent_id INT,
    rating INT CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE SET NULL,
    INDEX idx_agent_id (agent_id),
    INDEX idx_rating (rating)
);
```

---

### **๐ GROUP 8: ACTIVITY LOG & AUDIT (1 ุฌุฏูู)**

#### **21. activity_log**
```sql
CREATE TABLE activity_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    action VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50),  -- tickets, messages, templates, etc
    entity_id INT,
    old_value JSON,
    new_value JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
);
```

---

## ๏ฟฝ **4. ูุธุงู ุงููุตุงุฏูุฉ ูุงูุตูุงุญูุงุช (Authentication & Authorization)**

### **๐ ูุธุฑุฉ ุนุงูุฉ:**

```
๐ ูุธุงู ุงููุตุงุฏูุฉ:
   โโโ ุชุณุฌูู ุงูุฏุฎูู: Username + Password
   โโโ ุงูุฌูุณุงุช: Django Sessions
   โโโ ุงูุชุดููุฑ: bcrypt (Django default)
   โโโ ุงูุญูุงูุฉ: CSRF + Rate Limiting + Brute Force Protection

๐ฅ ุงูุฃุฏูุงุฑ (Roles):
   โโโ Admin: ุตูุงุญูุงุช ูุงููุฉ (7 ุตูุญุงุช)
   โโโ Agent: ุตูุงุญูุงุช ูุญุฏูุฏุฉ (3 ุตูุญุงุช ููุท)

๐ก๏ธ ุงูุตูุงุญูุงุช:
   โโโ Admin: ูุฑู ููุฏูุฑ ูู ุดูุก
   โโโ Agent: ูุฑู ูุญุงุฏุซุงุชู ูููุงูุจู ููุท
```

---

### **๐ฏ 4.1 ุชุณุฌูู ุงูุฏุฎูู (Login Flow)**

#### **ุงูุณููุงุฑูู ุงููุงูู:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู                        โ
โ                                                             โ
โ         Username: [____________]                            โ
โ         Password: [____________]                            โ
โ                   [ุชุณุฌูู ุงูุฏุฎูู]                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                    ุงูุชุญูู ูู ุงูุจูุงูุงุช
                            โ
                โโโโโโโโโโโโโดโโโโโโโโโโโโ
                โ                       โ
         โ Admin                   โ Agent
                โ                       โ
    โโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ
    โ Dashboard Admin   โ    โ ุตูุญุฉ ุงููุญุงุฏุซุงุช   โ
    โ (7 ุตูุญุงุช)        โ    โ (3 ุตูุญุงุช ููุท)    โ
    โโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ
```

---

#### **Queries - ุชุณุฌูู ุงูุฏุฎูู:**

```sql
-- Query 1: ุงูุชุญูู ูู ุงููุณุชุฎุฏู
SELECT
    u.id,
    u.username,
    u.password_hash,
    u.role,
    u.is_active,
    u.full_name,
    u.email,
    CASE
        WHEN u.role = 'agent' THEN a.id
        WHEN u.role = 'admin' THEN ad.id
    END as role_id
FROM users u
LEFT JOIN agents a ON u.id = a.user_id
LEFT JOIN admins ad ON u.id = ad.user_id
WHERE u.username = ?
  AND u.is_active = TRUE
LIMIT 1;

-- Query 2: ุชุญุฏูุซ ุขุฎุฑ ุฏุฎูู
UPDATE users
SET last_login = NOW(),
    is_online = TRUE
WHERE id = ?;

-- Query 3: ุชุณุฌูู ูู activity_log
INSERT INTO activity_log (
    user_id,
    action_type,
    description,
    ip_address,
    user_agent
) VALUES (?, 'login', 'ุชุณุฌูู ุฏุฎูู ูุงุฌุญ', ?, ?);
```

---

### **๐ฅ 4.2 ุฅูุดุงุก ุงููุณุชุฎุฏููู (User Creation)**

#### **ูู ููููู ุฅูุดุงุก ูุณุชุฎุฏูููุ**
```
โ Admin ููุท
โ Agent ูุง ููููู
```

#### **ุงูุณููุงุฑูู:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Admin โ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูููุธููู                    โ
โ                                                             โ
โ  [+ ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ]                                       โ
โ                                                             โ
โ  Username:     [____________]                               โ
โ  Password:     [____________]                               โ
โ  Full Name:    [____________]                               โ
โ  Email:        [____________]                               โ
โ  Role:         [โ Agent  โ Admin]                          โ
โ  Max Tickets:  [15]                                         โ
โ                                                             โ
โ              [ุญูุธ]  [ุฅูุบุงุก]                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                    ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                            โ
            โโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ
            โ                               โ
    INSERT INTO users          INSERT INTO agents/admins
    (username, password_hash,  (user_id, ...)
     role, ...)
```

---

#### **Queries - ุฅูุดุงุก ูุณุชุฎุฏู:**

```sql
-- Query 1: ุฅูุดุงุก ูู ุฌุฏูู users
INSERT INTO users (
    username,
    password_hash,
    email,
    full_name,
    role,
    created_by
) VALUES (?, ?, ?, ?, ?, ?);

-- Query 2: ุฅูุดุงุก ูู ุฌุฏูู agents (ุฅุฐุง ูุงู ููุธู)
INSERT INTO agents (
    user_id,
    max_concurrent_tickets,
    department
) VALUES (LAST_INSERT_ID(), 15, ?);

-- ุฃู Query 3: ุฅูุดุงุก ูู ุฌุฏูู admins (ุฅุฐุง ูุงู ุฃุฏูู)
INSERT INTO admins (
    user_id,
    permissions_level
) VALUES (LAST_INSERT_ID(), 'full');

-- Query 4: ุชุณุฌูู ูู activity_log
INSERT INTO activity_log (
    user_id,
    action_type,
    description,
    ip_address
) VALUES (?, 'create_user', CONCAT('ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ: ', ?), ?);
```

---

### **๐ 4.3 ุงูุตูุงุญูุงุช ุงูุชูุตูููุฉ (Detailed Permissions)**

#### **Admin - 7 ุตูุญุงุช:**

```
โ 1. Dashboard (ุฅุญุตุงุฆูุงุช ุดุงููุฉ)
   โโโ ุนุฏุฏ ุงูุชุฐุงูุฑ (ุงููู)
   โโโ ุนุฏุฏ ุงูููุธููู
   โโโ ูุชูุณุท ููุช ุงูุฑุฏ (ุงููู)
   โโโ ุฑุถุง ุงูุนููุงุก (ุงููู)
   โโโ ุณุงุนุงุช ุงูุฐุฑูุฉ

โ 2. ุฅุฏุงุฑุฉ ุงูููุธููู
   โโโ ุนุฑุถ ุฌููุน ุงูููุธููู
   โโโ ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ
   โโโ ุชุนุฏูู ุจูุงูุงุช ููุธู
   โโโ ุชุนุทูู/ุชูุนูู ููุธู
   โโโ ุญุฐู ููุธู

โ 3. ุฅุฏุงุฑุฉ ุงูุนููุงุก
   โโโ ุนุฑุถ ุฌููุน ุงูุนููุงุก
   โโโ ุจุญุซ ุนู ุนููู
   โโโ ุนุฑุถ ุชุงุฑูุฎ ูุญุงุฏุซุงุช ุงูุนููู (ูุน ุฌููุน ุงูููุธููู)
   โโโ ุฅุถุงูุฉ Tags ููุนููู
   โโโ ุฅุถุงูุฉ ููุงุญุธุงุช ุนูู ุงูุนููู

โ 4. ุฌููุน ุงูุชุฐุงูุฑ
   โโโ ุนุฑุถ ุฌููุน ุงูุชุฐุงูุฑ (ูุฌููุน ุงูููุธููู)
   โโโ ููุชุฑุฉ ุญุณุจ ุงูููุธู/ุงูุญุงูุฉ/ุงูุชุงุฑูุฎ
   โโโ ููู ุชุฐูุฑุฉ ูู ููุธู ูุขุฎุฑ
   โโโ ุฅุบูุงู ุฃู ุชุฐูุฑุฉ
   โโโ ุนุฑุถ ุชูุงุตูู ุฃู ูุญุงุฏุซุฉ

โ 5. ุงูููุงูุจ ุงูุนุงูุฉ (Global Templates)
   โโโ ุนุฑุถ ุฌููุน ุงูููุงูุจ ุงูุนุงูุฉ
   โโโ ุฅุถุงูุฉ ูุงูุจ ุนุงู ุฌุฏูุฏ
   โโโ ุชุนุฏูู ูุงูุจ ุนุงู
   โโโ ุญุฐู ูุงูุจ ุนุงู
   โโโ ุชูุนูู/ุชุนุทูู ูุงูุจ

โ 6. ุงูุชูุงุฑูุฑ
   โโโ ุชูุฑูุฑ ุฃุฏุงุก ุงูููุธููู (ุฌููุน ุงูููุธููู)
   โโโ ุชูุฑูุฑ ุฑุถุง ุงูุนููุงุก (ุงููู)
   โโโ ุชูุฑูุฑ ุณุงุนุงุช ุงูุฐุฑูุฉ
   โโโ ุชูุฑูุฑ ุงูุชุฃุฎูุฑุงุช (ุฌููุน ุงูููุธููู)
   โโโ ุชูุฑูุฑ ุงูุนููุงุก ุงูุฃูุซุฑ ูุดุงุทุงู

โ 7. ุงูุฅุนุฏุงุฏุงุช
   โโโ ุฅุนุฏุงุฏุงุช ุงููุธุงู
   โโโ ุฅุนุฏุงุฏุงุช WhatsApp (ุงููุฑุญูุฉ 2)
   โโโ ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
   โโโ Activity Log (ุณุฌู ุงููุดุงุท - ุงููู)
   โโโ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู
```

---

#### **Agent - 3 ุตูุญุงุช ููุท:**

```
โ 1. ูุญุงุฏุซุงุชู (My Conversations)
   โโโ ุนุฑุถ ูุญุงุฏุซุงุชู ููุท (assigned_agent_id = current_user.agent_id)
   โโโ ุงูุจุญุซ ูู ูุญุงุฏุซุงุชู (ุงุณู/ุฑูู/ุฑุณุงูุฉ)
   โโโ ููุชุฑุฉ ูุญุงุฏุซุงุชู (ููุชูุญุฉ/ูุชุฃุฎุฑุฉ/ูุบููุฉ)
   โโโ ุงูุฑุฏ ุนูู ุงูุฑุณุงุฆู
   โโโ ุงุณุชุฎุฏุงู ุงูููุงูุจ (ุงูุนุงูุฉ + ุงูุฎุงุตุฉ)
   โโโ ุฅููุงุก ุงููุญุงุฏุซุฉ

   โ ูุง ูุฑู ูุญุงุฏุซุงุช ุงูููุธููู ุงูุขุฎุฑูู
   โ ูุง ููููู ููู ุชุฐูุฑุฉ ูููุธู ุขุฎุฑ

โ 2. ููุงูุจู ุงูุฎุงุตุฉ (My Templates)
   โโโ ุนุฑุถ ููุงูุจู ุงูุฎุงุตุฉ ููุท (agent_id = current_user.agent_id)
   โโโ ุนุฑุถ ุงูููุงูุจ ุงูุนุงูุฉ (ูููุฑุงุกุฉ ูุงูุงุณุชุฎุฏุงู ููุท)
   โโโ ุฅุถุงูุฉ ูุงูุจ ุฎุงุต ุฌุฏูุฏ
   โโโ ุชุนุฏูู ููุงูุจู ุงูุฎุงุตุฉ
   โโโ ุญุฐู ููุงูุจู ุงูุฎุงุตุฉ

   โ ูุง ูุฑู ููุงูุจ ุงูููุธููู ุงูุขุฎุฑูู
   โ ูุง ููููู ุชุนุฏูู ุงูููุงูุจ ุงูุนุงูุฉ

โ 3. ุชูุงุฑูุฑู ุงูุดุฎุตูุฉ (My Reports)
   โโโ ุนุฏุฏ ุชุฐุงูุฑู (ููุชูุญุฉ/ูุบููุฉ/ูุชุฃุฎุฑุฉ)
   โโโ ูุชูุณุท ููุช ุงูุฑุฏ ุงูุฎุงุต ุจู
   โโโ ุฑุถุง ุงูุนููุงุก ุนูู
   โโโ KPIs ุงูุฎุงุตุฉ ุจู
   โโโ ุชุงุฑูุฎ ุฃุฏุงุฆู (ุดูุฑู)

   โ ูุง ูุฑู ุชูุงุฑูุฑ ุงูููุธููู ุงูุขุฎุฑูู
   โ ูุง ูุฑู ุงูุฅุญุตุงุฆูุงุช ุงูุดุงููุฉ
```

---

### **๐ก๏ธ 4.4 ุงูุชุญูู ูู ุงูุตูุงุญูุงุช (Permission Checks)**

#### **Queries - ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:**

```sql
-- Query 1: ุงูุชุญูู ูู ุฃู ุงูููุธู ูููู ุงูุชุฐูุฑุฉ
SELECT COUNT(*) as has_access
FROM tickets t
WHERE t.id = ?
  AND t.assigned_agent_id = ?;
-- ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ 0 โ ููุณ ูู ุตูุงุญูุฉ
-- ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ 1 โ ูู ุตูุงุญูุฉ

-- Query 2: ุงูุชุญูู ูู ุฃู ุงููุงูุจ ูุฎุต ุงูููุธู
SELECT COUNT(*) as has_access
FROM agent_templates at
WHERE at.id = ?
  AND at.agent_id = ?;

-- Query 3: ุฌูุจ ูุญุงุฏุซุงุช ุงูููุธู ููุท
SELECT t.*, c.name, c.phone_number
FROM tickets t
JOIN customers c ON t.customer_id = c.id
WHERE t.assigned_agent_id = ?
ORDER BY t.last_message_at DESC;

-- Query 4: ุฌูุจ ููุงูุจ ุงูููุธู (ุงูุฎุงุตุฉ + ุงูุนุงูุฉ)
(SELECT id, title, content, 'personal' as type
 FROM agent_templates
 WHERE agent_id = ?)
UNION ALL
(SELECT id, title, content, 'global' as type
 FROM global_templates
 WHERE is_active = TRUE)
ORDER BY type, title;
```

---

#### **ูุซุงู ููุฏ - ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:**

```python
# Decorator ููุชุญูู ูู Admin
def admin_required(view_func):
    def wrapper(request, *args, **kwargs):
        if not request.user.is_authenticated:
            return redirect('login')

        if request.user.role != 'admin':
            # ุชุณุฌูู ูุญุงููุฉ ูุตูู ุบูุฑ ูุตุฑุญ
            ActivityLog.objects.create(
                user_id=request.user.id,
                action_type='unauthorized_access',
                description=f'ูุญุงููุฉ ูุตูู ูุตูุญุฉ Admin: {request.path}',
                ip_address=get_client_ip(request)
            )
            return HttpResponseForbidden("ุบูุฑ ูุตุฑุญ ูู ุจุงูุฏุฎูู")

        return view_func(request, *args, **kwargs)
    return wrapper

# ูุซุงู ุงุณุชุฎุฏุงู
@login_required
@admin_required
def admin_all_tickets(request):
    tickets = Ticket.objects.all()
    return render(request, 'admin_all_tickets.html', {'tickets': tickets})
```

```python
# ุงูุชุญูู ูู ุตูุงุญูุฉ Agent ุนูู ุชุฐูุฑุฉ ูุนููุฉ
@login_required
def agent_view_ticket(request, ticket_id):
    if request.user.role != 'agent':
        return HttpResponseForbidden("ุบูุฑ ูุตุฑุญ ูู")

    # ุงูุชุญูู ูู ุฃู ุงูุชุฐูุฑุฉ ุชุฎุต ุงูููุธู
    ticket = Ticket.objects.filter(
        id=ticket_id,
        assigned_agent_id=request.user.agent.id
    ).first()

    if not ticket:
        # ุชุณุฌูู ูุญุงููุฉ ูุตูู ุบูุฑ ูุตุฑุญ
        ActivityLog.objects.create(
            user_id=request.user.id,
            action_type='unauthorized_access',
            description=f'ูุญุงููุฉ ุงููุตูู ูุชุฐูุฑุฉ #{ticket_id} ุบูุฑ ูุฎุตุตุฉ ูู',
            ip_address=get_client_ip(request)
        )
        return HttpResponseForbidden("ูุฐู ุงูุชุฐูุฑุฉ ุบูุฑ ูุฎุตุตุฉ ูู")

    # ุนุฑุถ ุงูุชุฐูุฑุฉ
    messages = Message.objects.filter(ticket_id=ticket_id)
    return render(request, 'agent_ticket.html', {
        'ticket': ticket,
        'messages': messages
    })
```

---

### **๐ 4.5 ุงูุฃูุงู (Security Measures)**

#### **4.5.1 ุชุดููุฑ ูููุฉ ุงููุฑูุฑ**

```python
# Django - ุงุณุชุฎุฏุงู bcrypt (ุงูุงูุชุฑุงุถู)
from django.contrib.auth.hashers import make_password, check_password

# ุนูุฏ ุฅูุดุงุก ูุณุชุฎุฏู
password_hash = make_password('user_password')

# ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
is_valid = check_password('entered_password', stored_password_hash)
```

**ูุชุทูุจุงุช ูููุฉ ุงููุฑูุฑ:**
```
โ ุงูุญุฏ ุงูุฃุฏูู: 8 ุฃุญุฑู
โ ูุฌุจ ุฃู ุชุญุชูู ุนูู:
   โโโ ุญุฑู ูุจูุฑ ูุงุญุฏ ุนูู ุงูุฃูู (A-Z)
   โโโ ุญุฑู ุตุบูุฑ ูุงุญุฏ ุนูู ุงูุฃูู (a-z)
   โโโ ุฑูู ูุงุญุฏ ุนูู ุงูุฃูู (0-9)
   โโโ ุฑูุฒ ุฎุงุต ูุงุญุฏ ุนูู ุงูุฃูู (!@#$%^&*)
```

---

#### **4.5.2 ุงูุญูุงูุฉ ูู Brute Force**

```sql
-- ุฌุฏูู ูุชุชุจุน ูุญุงููุงุช ุงูุฏุฎูู ุงููุงุดูุฉ
CREATE TABLE login_attempts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    ip_address VARCHAR(45) NOT NULL,
    attempt_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    success BOOLEAN DEFAULT FALSE,

    INDEX idx_username (username),
    INDEX idx_ip_address (ip_address),
    INDEX idx_attempt_time (attempt_time)
);
```

```python
# ุงูุญูุงูุฉ ูู Brute Force
def check_brute_force(username, ip_address):
    # ุนุฏุฏ ุงููุญุงููุงุช ุงููุงุดูุฉ ูู ุขุฎุฑ 15 ุฏูููุฉ
    fifteen_minutes_ago = datetime.now() - timedelta(minutes=15)

    failed_attempts = LoginAttempt.objects.filter(
        username=username,
        success=False,
        attempt_time__gte=fifteen_minutes_ago
    ).count()

    if failed_attempts >= 5:
        return False, "ุชู ุญุธุฑ ุงูุญุณุงุจ ูุคูุชุงู. ุญุงูู ุจุนุฏ 15 ุฏูููุฉ"

    return True, None

# ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
def login_view(request):
    username = request.POST.get('username')
    password = request.POST.get('password')
    ip_address = get_client_ip(request)

    # ุงูุชุญูู ูู Brute Force
    allowed, error_msg = check_brute_force(username, ip_address)
    if not allowed:
        return JsonResponse({'error': error_msg}, status=429)

    # ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู
    user = authenticate(username=username, password=password)

    # ุชุณุฌูู ุงููุญุงููุฉ
    LoginAttempt.objects.create(
        username=username,
        ip_address=ip_address,
        success=(user is not None)
    )

    if user is None:
        return JsonResponse({'error': 'ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุฎุงุทุฆุฉ'}, status=401)

    # ูุฌุญ ุชุณุฌูู ุงูุฏุฎูู
    login(request, user)
    return JsonResponse({'success': True, 'role': user.role})
```

---

#### **4.5.3 CSRF Protection**

```python
# Django - ุชููุงุฆู ูู ูู POST request
# ูู HTML Forms:
<form method="POST">
    {% csrf_token %}
    <!-- form fields -->
</form>

# ูู AJAX requests:
fetch('/api/endpoint', {
    method: 'POST',
    headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
});
```

---

#### **4.5.4 Rate Limiting**

```python
# ุงุณุชุฎุฏุงู django-ratelimit
from django_ratelimit.decorators import ratelimit

# ุชุญุฏูุฏ ุนุฏุฏ ุงูุทูุจุงุช
@ratelimit(key='ip', rate='10/m', method='POST')  # 10 requests ูู ุงูุฏูููุฉ
def login_view(request):
    # ...

@ratelimit(key='user', rate='100/h')  # 100 request ูู ุงูุณุงุนุฉ
def api_endpoint(request):
    # ...
```

---

### **๐ 4.6 Activity Log - ุงูุฃุญุฏุงุซ ุงููุณุฌูุฉ**

```python
# ุงูุฃุญุฏุงุซ ุงูุชู ูุชู ุชุณุฌูููุง:

LOGGED_ACTIONS = {
    # Authentication
    'login': 'ุชุณุฌูู ุฏุฎูู',
    'logout': 'ุชุณุฌูู ุฎุฑูุฌ',
    'failed_login': 'ูุญุงููุฉ ุฏุฎูู ูุงุดูุฉ',

    # User Management (Admin ููุท)
    'create_user': 'ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ',
    'update_user': 'ุชุนุฏูู ุจูุงูุงุช ูุณุชุฎุฏู',
    'deactivate_user': 'ุชุนุทูู ูุณุชุฎุฏู',
    'activate_user': 'ุชูุนูู ูุณุชุฎุฏู',
    'delete_user': 'ุญุฐู ูุณุชุฎุฏู',
    'change_password': 'ุชุบููุฑ ูููุฉ ุงููุฑูุฑ',

    # Tickets
    'create_ticket': 'ุฅูุดุงุก ุชุฐูุฑุฉ',
    'assign_ticket': 'ุชูุฒูุน ุชุฐูุฑุฉ',
    'transfer_ticket': 'ููู ุชุฐูุฑุฉ',
    'close_ticket': 'ุฅุบูุงู ุชุฐูุฑุฉ',
    'reopen_ticket': 'ุฅุนุงุฏุฉ ูุชุญ ุชุฐูุฑุฉ',

    # Messages
    'send_message': 'ุฅุฑุณุงู ุฑุณุงูุฉ',
    'read_message': 'ูุฑุงุกุฉ ุฑุณุงูุฉ',

    # Templates
    'create_template': 'ุฅูุดุงุก ูุงูุจ',
    'update_template': 'ุชุนุฏูู ูุงูุจ',
    'delete_template': 'ุญุฐู ูุงูุจ',

    # Security
    'unauthorized_access': 'ูุญุงููุฉ ูุตูู ุบูุฑ ูุตุฑุญ',
    'permission_denied': 'ุฑูุถ ุตูุงุญูุฉ',
}
```

```sql
-- Query: ุฌูุจ Activity Log (Admin ููุท)
SELECT
    al.id,
    al.action_type,
    al.description,
    al.ip_address,
    al.created_at,
    u.username,
    u.full_name,
    u.role
FROM activity_log al
LEFT JOIN users u ON al.user_id = u.id
WHERE al.created_at >= ?  -- ูู ุชุงุฑูุฎ ูุนูู
ORDER BY al.created_at DESC
LIMIT 100;

-- Query: ุฌูุจ Activity Log ูููุธู ูุนูู (Agent ูุฑู ูุดุงุทู ููุท)
SELECT
    al.id,
    al.action_type,
    al.description,
    al.created_at
FROM activity_log al
WHERE al.user_id = ?
ORDER BY al.created_at DESC
LIMIT 50;
```

---

### **๐ฏ 4.7 ุงูุณููุงุฑูููุงุช ุงููุงููุฉ**

#### **ุงูุณููุงุฑูู 1: Admin ูุณุฌู ุงูุฏุฎูู**

```
1. Admin ูุฏุฎู username: admin_khalifa + password: Admin@2024
2. ุงููุธุงู ูุชุญูู ูู ุงูุจูุงูุงุช ูู ุฌุฏูู users
3. ุงููุธุงู ูุชุญูู ูู password_hash ุจุงุณุชุฎุฏุงู bcrypt
4. ุงููุธุงู ูุชุญูู ูู role = 'admin' โ
5. ุงููุธุงู ูุชุญูู ูู is_active = TRUE โ
6. ุงููุธุงู ูุญุฏุซ:
   โโโ last_login = NOW()
   โโโ is_online = TRUE
7. ุงููุธุงู ูุณุฌู ูู activity_log:
   โโโ action_type: 'login'
   โโโ description: 'ุชุณุฌูู ุฏุฎูู ูุงุฌุญ'
   โโโ ip_address: 192.168.1.100
8. ุงููุธุงู ูุณุฌู ูู login_attempts:
   โโโ username: admin_khalifa
   โโโ success: TRUE
   โโโ ip_address: 192.168.1.100
9. ุงููุธุงู ููุดุฆ Session
10. ุงููุธุงู ููุฌู Admin ุฅูู Dashboard
11. Dashboard ูุนุฑุถ:
    โโโ ุฅุญุตุงุฆูุงุช ุดุงููุฉ (ุฌููุน ุงูููุธููู)
    โโโ ุนุฏุฏ ุงูุชุฐุงูุฑ: 45 (ููุชูุญุฉ: 20, ูุชุฃุฎุฑุฉ: 5, ูุบููุฉ: 20)
    โโโ ุนุฏุฏ ุงูููุธููู: 10 (ูุดุท: 8, ุบูุฑ ูุดุท: 2)
    โโโ ูุชูุณุท ููุช ุงูุฑุฏ: 2.5 ุฏูููุฉ
    โโโ ุฑุถุง ุงูุนููุงุก: 4.2/5
```

---

#### **ุงูุณููุงุฑูู 2: Agent ูุณุฌู ุงูุฏุฎูู**

```
1. Agent ูุฏุฎู username: ahmed_agent + password: Ahmed@123
2. ุงููุธุงู ูุชุญูู ูู ุงูุจูุงูุงุช
3. ุงููุธุงู ูุชุญูู ูู password_hash โ
4. ุงููุธุงู ูุชุญูู ูู role = 'agent' โ
5. ุงููุธุงู ูุชุญูู ูู is_active = TRUE โ
6. ุงููุธุงู ูุญุฏุซ last_login ู is_online = TRUE
7. ุงููุธุงู ูุณุฌู ูู activity_log
8. ุงููุธุงู ูุณุฌู ูู login_attempts (success: TRUE)
9. ุงููุธุงู ููุดุฆ Session
10. ุงููุธุงู ููุฌู Agent ุฅูู ุตูุญุฉ ุงููุญุงุฏุซุงุช
11. ุตูุญุฉ ุงููุญุงุฏุซุงุช ุชุนุฑุถ:
    โโโ ูุญุงุฏุซุงุชู ููุท (assigned_agent_id = 5)
    โโโ ุนุฏุฏ ุงููุญุงุฏุซุงุช: 8
    โโโ ุบูุฑ ุงูููุฑูุกุฉ: 3
    โโโ ุงููุชุฃุฎุฑุฉ: 1
    โโโ ุขุฎุฑ ุฑุณุงูุฉ ูู ูู ูุญุงุฏุซุฉ
```

---

#### **ุงูุณููุงุฑูู 3: Admin ููุดุฆ ููุธู ุฌุฏูุฏ**

```
1. Admin ูุฏุฎู ุฅูู ุตูุญุฉ "ุฅุฏุงุฑุฉ ุงูููุธููู"
2. Admin ูุถุบุท "ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ"
3. Admin ูุฏุฎู:
   โโโ Username: mohamed_agent
   โโโ Password: Mohamed@2024
   โโโ Full Name: ูุญูุฏ ุฃุญูุฏ
   โโโ Email: mohamed@khalifa.com
   โโโ Role: Agent
   โโโ Max Tickets: 15
4. ุงููุธุงู ูุชุญูู ูู:
   โโโ Username ุบูุฑ ููุฑุฑ โ
   โโโ Email ุบูุฑ ููุฑุฑ โ
   โโโ Password ููู (8+ ุฃุญุฑูุ ูุจูุฑ+ุตุบูุฑ+ุฑูู+ุฑูุฒ) โ
   โโโ Admin ูู ุตูุงุญูุฉ (role='admin') โ
5. ุงููุธุงู ููุดุฆ:
   โโโ ุณุฌู ูู users:
   โ   โโโ username: mohamed_agent
   โ   โโโ password_hash: $2b$12$... (bcrypt)
   โ   โโโ role: 'agent'
   โ   โโโ created_by: admin.id
   โ   โโโ is_active: TRUE
   โโโ ุณุฌู ูู agents:
   โ   โโโ user_id: new_user.id
   โ   โโโ max_concurrent_tickets: 15
   โ   โโโ current_active_tickets: 0
   โโโ ุณุฌู ูู activity_log:
       โโโ user_id: admin.id
       โโโ action_type: 'create_user'
       โโโ description: 'ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ: mohamed_agent'
6. ุงููุธุงู ูุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ: "ุชู ุฅูุดุงุก ุงูููุธู ุจูุฌุงุญ"
7. ุงูููุธู ุงูุฌุฏูุฏ ููููู ุชุณุฌูู ุงูุฏุฎูู ุงูุขู
```

---

#### **ุงูุณููุงุฑูู 4: Agent ูุญุงูู ุงููุตูู ูุตูุญุฉ Admin**

```
1. Agent (ahmed_agent) ูุญุงูู ุงูุฏุฎูู ุฅูู /admin/all-tickets
2. ุงููุธุงู ูุชุญูู ูู Session โ
3. ุงููุธุงู ูุชุญูู ูู role
4. ุงููุธุงู ูุฌุฏ role = 'agent' (ููุณ admin) โ
5. ุงููุธุงู ูุณุฌู ูู activity_log:
   โโโ user_id: ahmed_agent.id
   โโโ action_type: 'unauthorized_access'
   โโโ description: 'ูุญุงููุฉ ูุตูู ูุตูุญุฉ Admin: /admin/all-tickets'
   โโโ ip_address: 192.168.1.105
6. ุงููุธุงู ูุนุฑุถ ุตูุญุฉ 403 Forbidden:
   "ุนุฐุฑุงูุ ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐู ุงูุตูุญุฉ"
7. ุฃู ูุนูุฏ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุฎุงุตุฉ ุจู
```

---

#### **ุงูุณููุงุฑูู 5: Agent ูุญุงูู ุฑุคูุฉ ูุญุงุฏุซุฉ ููุธู ุขุฎุฑ**

```
1. Agent (ahmed_agent, agent_id=5) ูุญุงูู ูุชุญ /conversations/ticket/123
2. ุงููุธุงู ูุชุญูู ูู Session โ
3. ุงููุธุงู ูุชุญูู ูู role = 'agent' โ
4. ุงููุธุงู ูุณุชุนูู:
   SELECT assigned_agent_id
   FROM tickets
   WHERE id = 123
5. ุงููุธุงู ูุฌุฏ assigned_agent_id = 7 (ููุธู ุขุฎุฑ)
6. ุงููุธุงู ููุงุฑู: 7 โ 5 (current_user.agent_id) โ
7. ุงููุธุงู ูุณุฌู ูู activity_log:
   โโโ user_id: ahmed_agent.id
   โโโ action_type: 'unauthorized_access'
   โโโ description: 'ูุญุงููุฉ ุงููุตูู ูุชุฐูุฑุฉ #123 ุบูุฑ ูุฎุตุตุฉ ูู'
   โโโ ticket_id: 123
8. ุงููุธุงู ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ:
   "ูุฐู ุงููุญุงุฏุซุฉ ุบูุฑ ูุฎุตุตุฉ ูู"
9. ุงููุธุงู ูุนูุฏ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ูุญุงุฏุซุงุชู
```

---

#### **ุงูุณููุงุฑูู 6: ูุญุงููุฉ Brute Force Attack**

```
1. ููุงุฌู ูุญุงูู ุชุณุฌูู ุงูุฏุฎูู:
   โโโ ุงููุญุงููุฉ 1: username: admin, password: 123456 โ
   โโโ ุงููุญุงููุฉ 2: username: admin, password: admin123 โ
   โโโ ุงููุญุงููุฉ 3: username: admin, password: password โ
   โโโ ุงููุญุงููุฉ 4: username: admin, password: 12345678 โ
   โโโ ุงููุญุงููุฉ 5: username: admin, password: qwerty โ

2. ุงููุธุงู ูุณุฌู ูู ูุญุงููุฉ ูู login_attempts:
   โโโ username: admin
   โโโ success: FALSE
   โโโ ip_address: 203.0.113.50

3. ุนูุฏ ุงููุญุงููุฉ 6:
   โโโ ุงููุธุงู ูุนุฏ ุงููุญุงููุงุช ุงููุงุดูุฉ ูู ุขุฎุฑ 15 ุฏูููุฉ
   โโโ ุงููุชูุฌุฉ: 5 ูุญุงููุงุช ูุงุดูุฉ
   โโโ ุงููุธุงู ูุฑูุถ ุงููุญุงููุฉ

4. ุงููุธุงู ูุนุฑุถ ุฑุณุงูุฉ:
   "ุชู ุญุธุฑ ุงูุญุณุงุจ ูุคูุชุงู. ุญุงูู ุจุนุฏ 15 ุฏูููุฉ"

5. ุงููุธุงู ูุณุฌู ูู activity_log:
   โโโ action_type: 'brute_force_attempt'
   โโโ description: 'ูุญุงููุฉ Brute Force ุนูู ุญุณุงุจ: admin'
   โโโ ip_address: 203.0.113.50

6. ุจุนุฏ 15 ุฏูููุฉุ ูููู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
```

---

#### **ุงูุณููุงุฑูู 7: ุชุณุฌูู ุงูุฎุฑูุฌ**

```
1. User (Admin ุฃู Agent) ูุถุบุท "ุชุณุฌูู ุงูุฎุฑูุฌ"
2. ุงููุธุงู ูุญุฏุซ:
   UPDATE users
   SET is_online = FALSE
   WHERE id = ?
3. ุงููุธุงู ูุณุฌู ูู activity_log:
   โโโ user_id: user.id
   โโโ action_type: 'logout'
   โโโ description: 'ุชุณุฌูู ุฎุฑูุฌ'
4. ุงููุธุงู ูุญุฐู Session
5. ุงููุธุงู ูุนูุฏ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
```

---

### **๐ 4.8 ููุฎุต Queries ุงูู Authentication**

```
ุฅุฌูุงูู Queries ุงูู Authentication:

โ Login: 3 queries
   โโโ ุงูุชุญูู ูู ุงููุณุชุฎุฏู
   โโโ ุชุญุฏูุซ last_login
   โโโ ุชุณุฌูู ูู activity_log

โ Logout: 2 queries
   โโโ ุชุญุฏูุซ is_online
   โโโ ุชุณุฌูู ูู activity_log

โ Create User: 4 queries
   โโโ INSERT INTO users
   โโโ INSERT INTO agents/admins
   โโโ ุชุณุฌูู ูู activity_log
   โโโ ุงูุชุญูู ูู Username/Email

โ Check Permission (Ticket): 1 query
โ Check Permission (Template): 1 query
โ Deactivate User: 2 queries
โ Brute Force Check: 1 query
โ Get Activity Log: 1 query

ุงููุฌููุน: 15+ query
```

---

### **๐ 4.9 ุชุญุฏูุซ ุฌุฏูู users**

```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,  -- ููุชุณุฌูู
    password_hash VARCHAR(255) NOT NULL,    -- bcrypt hash
    email VARCHAR(150) UNIQUE NOT NULL,
    full_name VARCHAR(150),
    role ENUM('admin', 'agent') NOT NULL,   -- ุงูุฏูุฑ

    -- Account Status
    is_active BOOLEAN DEFAULT TRUE,         -- ููุนู/ูุนุทู
    is_online BOOLEAN DEFAULT FALSE,        -- ูุชุตู ุงูุขู
    last_login TIMESTAMP NULL,              -- ุขุฎุฑ ุฏุฎูู

    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INT NULL,  -- Admin ุงูุฐู ุฃูุดุฃ ุงูุญุณุงุจ
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,

    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active),
    INDEX idx_is_online (is_online)
);
```

---

### **๐ 4.10 ุฌุฏูู login_attempts (ุฌุฏูุฏ)**

```sql
CREATE TABLE login_attempts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    ip_address VARCHAR(45) NOT NULL,
    user_agent TEXT,
    success BOOLEAN DEFAULT FALSE,
    attempt_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_username (username),
    INDEX idx_ip_address (ip_address),
    INDEX idx_attempt_time (attempt_time),
    INDEX idx_success (success)
);
```

---

## ๏ฟฝ **5. Driver Pattern Architecture**

### **๐ ูุธุฑุฉ ุนุงูุฉ:**

```
๐ฏ ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ:
   ูุธุงู ูุฑู ูุณูุญ ุจุงูุชุจุฏูู ุจูู ูุฒูุฏู WhatsApp ุจุฏูู ุชุบููุฑ ุงูููุฏ ุงูุชุฌุงุฑู

๐ ุงููุจุฏุฃ:
   โโโ Interface ููุญุฏ (MessageDriver)
   โโโ Core ูุง ูุนุฑู ูุฒูุฏ WhatsApp
   โโโ Drivers ูุงุจูุฉ ููุชุจุฏูู
   โโโ ุจูุงูุงุช ููุญุฏุฉ (provider + id_ext)

๐ฆ ุงูู Drivers:
   โโโ WPPConnect Driver (ุงููุฑุญูุฉ 2 - ุงูุฌุฒุก 1)
   โ   โโโ QR Code Scan
   โ   โโโ ูุฌุงูู
   โ   โโโ ุณุฑูุน ุงูุชุทุจูู
   โ
   โโโ Cloud API Driver (ุงููุฑุญูุฉ 2 - ุงูุฌุฒุก 2)
       โโโ WhatsApp Business Cloud API
       โโโ ุฑุณูู ูููุซูู
       โโโ ูุฏููุน

๐ ุงูุชุญููู:
   ุชุบููุฑ WHATSAPP_DRIVER ูู .env ููุท
   โ ูู ุดูุก ุขุฎุฑ ูุนูู ุชููุงุฆูุงู
```

---

### **๐๏ธ 5.1 ุงููุนูุงุฑูุฉ (Architecture)**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Django Application                       โ
โ                   (Business Logic Core)                     โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ    โ
โ  โ   Tickets    โ  โ   Messages   โ  โ   Agents     โ    โ
โ  โ   Manager    โ  โ   Handler    โ  โ   Manager    โ    โ
โ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ    โ
โ         โ                 โ                 โ              โ
โ         โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโ              โ
โ                           โ                                โ
โ              โโโโโโโโโโโโโโโโโโโโโโโโโโ                    โ
โ              โ   MessageDriver        โ                    โ
โ              โ   (Abstract Interface) โ                    โ
โ              โโโโโโโโโโโโโโฌโโโโโโโโโโโโ                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
              โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ
              โ    Driver Factory         โ
              โ  (based on WHATSAPP_DRIVER)โ
              โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                            โ
              โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ
              โ                           โ
    โโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโ
    โ WPPConnect      โ         โ Cloud API       โ
    โ Driver          โ         โ Driver          โ
    โ                 โ         โ                 โ
    โ - QR Scan       โ         โ - Official API  โ
    โ - Free          โ         โ - Paid          โ
    โ - Quick Setup   โ         โ - Reliable      โ
    โโโโโโโโโโฌโโโโโโโโโ         โโโโโโโโโโฌโโโโโโโโโ
             โ                           โ
             โ                           โ
    โโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโ
    โ Redis Queue     โ         โ Redis Queue     โ
    โ (Incoming)      โ         โ (Incoming)      โ
    โโโโโโโโโโฌโโโโโโโโโ         โโโโโโโโโโฌโโโโโโโโโ
             โ                           โ
             โ                           โ
       WhatsApp Web              WhatsApp Business
       (QR Code)                 Cloud API
```

---

## ๏ฟฝ๏ฟฝ๐ **5. ุฎุฑูุทุฉ ุงูุนูุงูุงุช ุงููุงููุฉ (Foreign Keys Map)**

### **๐ ุฌููุน ุงูุนูุงูุงุช ุจูู ุงูุฌุฏุงูู**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    USERS (ุงูุฌุฏูู ุงูุฑุฆูุณู)                      โ
โ                           id (PK)                               โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
             โ                                    โ
             โผ                                    โผ
    โโโโโโโโโโโโโโโโโโ                   โโโโโโโโโโโโโโโโโโ
    โ    AGENTS      โ                   โ    ADMINS      โ
    โ  user_id ()  โ                   โ  user_id ()  โ
    โ      id (PK)   โ                   โ      id (PK)   โ
    โโโโโโโโโโฌโโโโโโโโ                   โโโโโโโโโโฌโโโโโโโโ
             โ                                    โ
             โ                                    โ
             โผ                                    โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                    TICKETS                          โ
    โ  assigned_agent_id () โ agents.id                 โ
    โ  customer_id () โ customers.id                    โ
    โ                  id (PK)                            โ
    โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโ
         โ                                        โ
         โผ                                        โผ
โโโโโโโโโโโโโโโโโโ                      โโโโโโโโโโโโโโโโโโโโ
โ   MESSAGES     โ                      โ TICKET_TRANSFERS โ
โ ticket_id () โ                      โ  ticket_id ()  โ
โ sender_id () โ                      โfrom_agent_id() โ
โ                โ                      โ to_agent_id () โ
โโโโโโโโโโโโโโโโโโ                      โโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       CUSTOMERS                                 โ
โ                         id (PK)                                 โ
โโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ
     โ              โ              โ              โ
     โผ              โผ              โผ              โผ
โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ TICKETS  โ  โCUSTOMER  โ  โCUSTOMER  โ  โCUSTOMER_     โ
โcustomer  โ  โ  _TAGS   โ  โ _NOTES   โ  โSATISFACTION  โ
โ_id ()  โ  โcustomer  โ  โcustomer  โ  โcustomer_id   โ
โ          โ  โ_id ()  โ  โ_id ()  โ  โ    ()      โ
โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
```

---

### **๐ ุฌุฏูู ุงูุนูุงูุงุช ุงูุชูุตููู (33 ุนูุงูุฉ)**

| **#** | **ุงูุฌุฏูู ุงููุฑุนู** | **ุงูุญูู ()** | **ูุดูุฑ ุฅูู** | **ุนูุฏ ุงูุญุฐู** |
|-------|-------------------|----------------|--------------|---------------|
| 1 | **agents** | user_id | users.id | CASCADE |
| 2 | **admins** | user_id | users.id | CASCADE |
| 3 | **tickets** | customer_id | customers.id | CASCADE |
| 4 | **tickets** | assigned_agent_id | agents.id | SET NULL |
| 5 | **tickets** | current_agent_id | agents.id | SET NULL |
| 6 | **messages** | ticket_id | tickets.id | CASCADE |
| 7 | **messages** | sender_id | users.id | SET NULL |
| 8 | **message_delivery_log** | message_id | messages.id | CASCADE |
| 9 | **message_search_index** | message_id | messages.id | CASCADE |
| 10 | **message_search_index** | customer_id | customers.id | CASCADE |
| 11 | **message_search_index** | ticket_id | tickets.id | CASCADE |
| 12 | **customer_tags** | customer_id | customers.id | CASCADE |
| 13 | **customer_notes** | customer_id | customers.id | CASCADE |
| 14 | **customer_notes** | created_by | users.id | SET NULL |
| 15 | **ticket_transfers_log** | ticket_id | tickets.id | CASCADE |
| 16 | **ticket_transfers_log** | from_agent_id | agents.id | SET NULL |
| 17 | **ticket_transfers_log** | to_agent_id | agents.id | SET NULL |
| 18 | **ticket_transfers_log** | transferred_by | admins.id | SET NULL |
| 19 | **ticket_states_log** | ticket_id | tickets.id | CASCADE |
| 20 | **global_templates** | created_by | admins.id | CASCADE |
| 21 | **global_templates** | updated_by | admins.id | SET NULL |
| 22 | **agent_templates** | agent_id | agents.id | CASCADE |
| 23 | **auto_reply_triggers** | template_id | global_templates.id | SET NULL |
| 24 | **response_time_tracking** | ticket_id | tickets.id | CASCADE |
| 25 | **response_time_tracking** | agent_id | agents.id | SET NULL |
| 26 | **agent_delay_events** | ticket_id | tickets.id | CASCADE |
| 27 | **agent_delay_events** | agent_id | agents.id | CASCADE |
| 28 | **agent_kpi** | agent_id | agents.id | CASCADE |
| 29 | **agent_kpi_monthly** | agent_id | agents.id | CASCADE |
| 30 | **customer_satisfaction** | ticket_id | tickets.id | CASCADE |
| 31 | **customer_satisfaction** | agent_id | agents.id | SET NULL |
| 32 | **customer_satisfaction** | customer_id | customers.id | CASCADE |
| 33 | **activity_log** | user_id | users.id | SET NULL |
| 34 | **activity_log** | ticket_id | tickets.id | SET NULL |

---

### **๐ ููุงุญุธุงุช ูููุฉ ุนู ุงูุนูุงูุงุช:**

#### **1. CASCADE (ุงูุญุฐู ุงููุชุณูุณู)**
```
ุนูุฏ ุญุฐู:
โ User โ ููุญุฐู Agent/Admin ุงููุฑุชุจุท
โ Customer โ ุชูุญุฐู ุฌููุน Tickets ูุงูู Tags ูุงูู Notes
โ Ticket โ ุชูุญุฐู ุฌููุน Messages ูุงูู Logs
โ Agent โ ุชูุญุฐู ุฌููุน KPIs ูุงูู Templates
โ Message โ ุชูุญุฐู ุฌููุน Delivery Logs
```

#### **2. SET NULL (ุชุนููู NULL)**
```
ุนูุฏ ุญุฐู:
โ๏ธ Agent โ ุงูุชุฐุงูุฑ ุงููุฎุตุตุฉ ูู ุชุตุจุญ assigned_agent_id = NULL
โ๏ธ User โ ุงูุฑุณุงุฆู ุงููุฑุณูุฉ ููู ุชุตุจุญ sender_id = NULL
โ๏ธ Admin โ ุงูููุงูุจ ุงููููุดุฃุฉ ุชุจูู ููู created_by = NULL
```

#### **3. ุงูููุงุฑุณ (Indexes) ููุจุญุซ ุงูุณุฑูุน**
```sql
-- ูู ุฌุฏูู messages (ููุจุญุซ ูุซู WhatsApp Web)
INDEX idx_ticket_id (ticket_id)                -- ููุจุญุซ ุญุณุจ ุงูุชุฐูุฑุฉ
INDEX idx_sender_type (sender_type)            -- ููููุชุฑุฉ ุญุณุจ ุงููุฑุณู
INDEX idx_is_read (is_read)                    -- ููุจุญุซ ุนู ุบูุฑ ุงูููุฑูุกุฉ โญ
FULLTEXT INDEX idx_message_text (message_text) -- ููุจุญุซ ูู ุงููุต โญ

-- ูู ุฌุฏูู tickets
INDEX idx_assigned_agent (assigned_agent_id)   -- ููุจุญุซ ุญุณุจ ุงูููุธู
INDEX idx_status (status)                      -- ููููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ
INDEX idx_customer (customer_id)               -- ููุจุญุซ ุญุณุจ ุงูุนููู
INDEX idx_created_at (created_at)              -- ููุชุฑุชูุจ ุงูุฒููู

-- ูู ุฌุฏูู customers
INDEX idx_phone_number (phone_number)          -- ููุจุญุซ ุจุงูุฑูู โญ
INDEX idx_wa_id (wa_id)                        -- ููุจุญุซ ุจู WhatsApp ID
```

---

### **โ Query ููุชุญูู ูู ุณูุงูุฉ ุงูุนูุงูุงุช**

```sql
-- ุนุฑุถ ุฌููุน Foreign Keys ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
SELECT
    TABLE_NAME as 'ุงูุฌุฏูู',
    COLUMN_NAME as 'ุงูุญูู',
    CONSTRAINT_NAME as 'ุงุณู ุงูููุฏ',
    REFERENCED_TABLE_NAME as 'ูุดูุฑ ุฅูู ุฌุฏูู',
    REFERENCED_COLUMN_NAME as 'ูุดูุฑ ุฅูู ุญูู'
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE REFERENCED_TABLE_SCHEMA = 'khalifa_pharmacy'
  AND REFERENCED_TABLE_NAME IS NOT NULL
ORDER BY TABLE_NAME, COLUMN_NAME;
```

---

## ๐ฌ **5. ุงูุณููุงุฑูููุงุช ุงูุชูุตูููุฉ**

### **ุฏูุฑุฉ ุญูุงุฉ ุงูุชุฐูุฑุฉ:**
```
[1] new (ุฌุฏูุฏุฉ) โ ุชู ุฅูุดุงุคูุง ููุชู
    โ
[2] open (ููุชูุญุฉ) โ ุชู ุชูุฒูุนูุง ุนูู agent
    โ
[3] in_progress (ููุฏ ุงููุนุงูุฌุฉ) โ Agent ูุชูุงุนู
    โ
[4] pending (ูุชุฃุฎุฑุฉ) โ ุฅุฐุง ูุฑ 3 ุฏูุงุฆู ุจุฏูู ุฑุฏ
    โ
[5] closed (ูุบููุฉ) โ ุชู ุฅููุงุคูุง
```

---

### **ุงูุณููุงุฑูู 1: ุนููู ุฌุฏูุฏ ูุฑุณู ุฑุณุงูุฉ**
#### **ุงูุฎุทูุงุช:**

```
1. ุงุณุชูุจุงู ุฑุณุงูุฉ
   โโโ Phone: 01012345678
   โโโ Name: ูุญูุฏ (ุงุฎุชูุงุฑู)
   โโโ Content: "ูุญุชุงุฌ ุฏูุงุก ููุถุบุท"

2. ุงูุชุญูู ูู ุงูุนููู
   โโโ Query: SELECT * FROM customers WHERE phone_number = ?
   โโโ ุงููุชูุฌุฉ: ุบูุฑ ููุฌูุฏ
   โโโ Action: INSERT INTO customers (...) โ customer_id = 123

3. ุงูุจุญุซ ุนู Agent ูุชุงุญ (Load Balancing)
   โโโ Query: SELECT agents with current_active_tickets < 15
   โโโ ORDER BY current_active_tickets ASC
   โโโ ุงููุชูุฌุฉ:
   โ   โโโ ุฃุญูุฏ: 8 ุชุฐุงูุฑ โ ุงูุฃูู โ
   โ   โโโ ูุงุทูุฉ: 10 ุชุฐุงูุฑ
   โ   โโโ ุนูู: 12 ุชุฐุงูุฑ
   โโโ ุงูุงุฎุชูุงุฑ: ุฃุญูุฏ (agent_id = 456)

4. ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ
   โโโ INSERT INTO tickets (...)
   โโโ ticket_number: TKT-2025-000789
   โโโ customer_id: 123
   โโโ assigned_agent_id: 456
   โโโ status: 'open'
   โโโ ticket_id = 789

5. ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุงูุฃููู
   โโโ INSERT INTO messages (...)
   โโโ ticket_id: 789
   โโโ sender_type: 'customer'
   โโโ message_text: "ูุญุชุงุฌ ุฏูุงุก ููุถุบุท"

6. ุชุญุฏูุซ ุญุงูุฉ Agent
   โโโ UPDATE agents SET current_active_tickets = 9
   โโโ status: 'available' (ูุฃู 9 < 15)

7. ุฅุฑุณุงู ุฅุดุนุงุฑ (Socket.io)
   โโโ io.to('agent-456').emit('new_ticket', {...})
   โโโ Desktop Notification
   โโโ Sound Alert

8. ุจุฏุก Timer (3 ุฏูุงุฆู)
   โโโ setTimeout(() => checkDelay(789), 180000)
```

---

### **ุงูุณููุงุฑูู 2: Agent ูุฑุฏ ุนูู ุฑุณุงูุฉ**

```
1. Agent (ุฃุญูุฏ) ููุชุญ ุงูุชุฐูุฑุฉ #789
   โโโ GET /api/tickets/789/messages

2. Agent ููุชุจ ุงูุฑุฏ
   โโโ "ุฃููุงู ุจูุ ุฃู ููุน ุชุญุฏูุฏุงูุ"

3. ุญูุธ ุฑุณุงูุฉ Agent
   โโโ INSERT INTO messages (...)
   โโโ sender_type: 'agent'
   โโโ sender_id: 456

4. ุงูุชุญูู: ูู ุฃูู ุฑุฏุ
   โโโ SELECT first_response_at FROM tickets WHERE id = 789
   โโโ ุงููุชูุฌุฉ: NULL โ ูุนู

5. ุญุณุงุจ Response Time
   โโโ created_at: 10:30:00
   โโโ first_response_at: 10:32:15
   โโโ response_time: 135 ุซุงููุฉ (2.25 ุฏูููุฉ)
   โโโ โ ูู ุงูููุช (< 3 ุฏูุงุฆู)

6. ุชุญุฏูุซ ุงูุชุฐูุฑุฉ
   โโโ UPDATE tickets SET
   โโโ status = 'in_progress'
   โโโ first_response_at = NOW()
   โโโ response_time_seconds = 135
   โโโ is_delayed = FALSE

7. ุชุณุฌูู ูู response_time_tracking
   โโโ INSERT INTO response_time_tracking (...)

8. ุชุญุฏูุซ KPI
   โโโ UPDATE agent_kpi SET messages_sent++
```

---

### **ุงูุณููุงุฑูู 3: ุชุฃุฎุฑ Agent (Delay Detection)**

```
Cron Job ูุนูู ูู ุฏูููุฉ: checkDelayedTickets()

1. ุงูุจุญุซ ุนู ุชุฐุงูุฑ ูุชุฃุฎุฑุฉ
   โโโ Query: SELECT tickets WHERE
   โ   โโโ status = 'open'  (ููุชูุญุฉ ููุท)
   โ   โโโ first_response_at IS NULL  (ูู ูุฑุฏ ุจุนุฏ)
   โ   โโโ is_delayed = FALSE  (ูู ุชูุนููู ูุชุฃุฎุฑุฉ ุจุนุฏ)
   โ   โโโ (NOW() - created_at) > 180 seconds  (ูุฑ ุฃูุซุฑ ูู 3 ุฏูุงุฆู)
   โโโ ุงููุชูุฌุฉ: ุชุฐูุฑุฉ #850 (ูุฑ 4 ุฏูุงุฆู)

2. ุชุญุฏูุซ ุงูุชุฐูุฑุฉ ุฅูู DELAYED
   โโโ UPDATE tickets SET
   โโโ status = 'delayed'  โ ุงูุญุงูุฉ ุชุชุบูุฑ
   โโโ is_delayed = TRUE
   โโโ delay_started_at = NOW()  โ ุชุณุฌูู ููุช ุจุฏุงูุฉ ุงูุชุฃุฎูุฑ
   โโโ delay_count++

3. ุชุณุฌูู ุญุฏุซ ุงูุชุฃุฎูุฑ
   โโโ INSERT INTO agent_delay_events (
       ticket_id, agent_id, delay_started_at
   )

4. ุชุญุฏูุซ KPI
   โโโ UPDATE agent_kpi SET delay_count++

5. ุฅุดุนุงุฑ ููู Admin
   โโโ WebSocket: emit('agent_delay', {...})
   โโโ Desktop Notification (ุฃุญูุฑ)
   โโโ Sound Alert

6. ุชุญุฏูุซ ูุงุฌูุฉ Admin
   โโโ ุจุทุงูุฉ Agent โ ููู ุฃุญูุฑ ๐ด
   โโโ ุนุฑุถ "DELAY" badge
   โโโ ุนุฑุถ ุงูููุช: "4 ุฏูุงุฆู"
   โโโ ุฎูุงุฑุงุช: [ุชุญููู] [ุชูุจูู]
```

---

### **ุงูุณููุงุฑูู 3.1: Agent ูุฑุฏ ุจุนุฏ ุงูุชุฃุฎูุฑ** โญ **ุฌุฏูุฏ**

```
1. Agent ูุฑุฏ ุนูู ุชุฐูุฑุฉ ูุชุฃุฎุฑุฉ
   โโโ ticket_id: 850
   โโโ status ุงูุญุงูู: 'delayed'
   โโโ delay_started_at: 10:33:00

2. ุญุณุงุจ ููุช ุงูุชุฃุฎูุฑ
   โโโ delay_started_at: 10:33:00
   โโโ NOW(): 10:37:30
   โโโ delay_duration: 4.5 ุฏูููุฉ (270 ุซุงููุฉ)

3. ุชุญุฏูุซ ุงูุชุฐูุฑุฉ - ุงูุนูุฏุฉ ูู OPEN
   โโโ UPDATE tickets SET
   โโโ status = 'open'  โ ุชุฑุฌุน ููุชูุญุฉ
   โโโ is_delayed = FALSE
   โโโ total_delay_minutes += 4.5  โ ููุญุณุจ ุงูุชุฃุฎูุฑ
   โโโ first_response_at = NOW()
   โโโ delay_started_at = NULL

4. ุชุญุฏูุซ ุญุฏุซ ุงูุชุฃุฎูุฑ
   โโโ UPDATE agent_delay_events SET
       โโโ delay_ended_at = NOW()
       โโโ delay_duration_seconds = 270

5. ุชุญุฏูุซ KPI
   โโโ UPDATE agent_kpi SET
   โโโ total_delay_minutes += 4.5  โ ููุญุณุจ ุนูู ุงูููุธู
   โโโ quality_score = recalculate()

6. ุฅุดุนุงุฑ ููู Admin
   โโโ WebSocket: emit('delay_resolved', {...})
   โโโ ุจุทุงูุฉ Agent โ ููู ุฃุฎุถุฑ โ

โ๏ธ **ููู:** ุงูุชุฃุฎูุฑ ููุญุณุจ ุนูู ุงูููุธู ุญุชู ูู ุฑุฏ ุจุนุฏูุง!
```

---

### **ุงูุณููุงุฑูู 4: Agent ูููู ุงููุญุงุฏุซุฉ**

```
1. Agent ูุถุบุท "ุฅููุงุก ุงููุญุงุฏุซุฉ"
   โโโ ticket_id: 789

2. ุงูุชุญูู ูู ุงูุตูุงุญูุฉ
   โโโ assigned_agent_id == current_user_id
   โโโ โ ุตุญูุญ

3. ุฅุบูุงู ุงูุชุฐูุฑุฉ
   โโโ UPDATE tickets SET
   โโโ status = 'closed'
   โโโ closed_at = NOW()
   โโโ closed_by_user_id = 456
   โโโ handling_time_seconds = (NOW() - created_at)

4. ุญุณุงุจ Handling Time
   โโโ created_at: 10:30:00
   โโโ closed_at: 10:45:30
   โโโ handling_time: 930 ุซุงููุฉ (15.5 ุฏูููุฉ)

5. ุชุญุฏูุซ ุญุงูุฉ Agent
   โโโ UPDATE agents SET
   โโโ current_active_tickets: 9 โ 8
   โโโ status: 'available'

6. ุชุญุฏูุซ KPI
   โโโ UPDATE agent_kpi SET
   โโโ total_tickets_closed++
   โโโ avg_handling_time = recalculate()

7. ุชุณุฌูู ูู ticket_states_log
   โโโ INSERT (old_state='in_progress', new_state='closed')
```

---

### **ุงูุณููุงุฑูู 5: Admin ูุญูู ุชุฐูุฑุฉ**

```
1. Admin ูุฎุชุงุฑ ุชุฐูุฑุฉ #789
   โโโ ุงูููุธู ุงูุญุงูู: ุฃุญูุฏ (12 ุชุฐูุฑุฉ)
   โโโ ูุฑูุฏ ุงูุชุญููู

2. Admin ูุฎุชุงุฑ ููุธู ุฌุฏูุฏ
   โโโ ูุงุทูุฉ (8 ุชุฐุงูุฑ)

3. ุงูุชุญูู ูู ุงูุชููุฑ
   โโโ Query: SELECT active_tickets_count FROM agents WHERE id = 999
   โโโ ุงููุชูุฌุฉ: 8 ุชุฐุงูุฑ
   โโโ โ ูุชุงุญ (8 < 15)

4. ุชุณุฌูู ุงูุชุญููู
   โโโ INSERT INTO ticket_transfers_log (...)
   โโโ from_agent_id: 456 (ุฃุญูุฏ)
   โโโ to_agent_id: 999 (ูุงุทูุฉ)
   โโโ transferred_by: 111 (admin_id)
   โโโ reason: "ุฅุนุงุฏุฉ ุชูุฒูุน ุงูุญูู"

5. ุชุญุฏูุซ ุงูุชุฐูุฑุฉ
   โโโ UPDATE tickets SET assigned_agent_id = 999

6. ุชุญุฏูุซ ุญุงูุฉ ุฃุญูุฏ
   โโโ current_active_tickets: 12 โ 11
   โโโ status: 'available'

7. ุชุญุฏูุซ ุญุงูุฉ ูุงุทูุฉ
   โโโ current_active_tickets: 8 โ 9
   โโโ status: 'available'

8. ุฅุดุนุงุฑุงุช
   โโโ ููุงุทูุฉ: "ุชู ุชุญููู ุชุฐูุฑุฉ #789 ุฅููู"
   โโโ ูุฃุญูุฏ: "ุชู ุชุญููู ุชุฐูุฑุฉ #789 ููู"

9. ุชุณุฌูู ูู activity_log
   โโโ INSERT (action='ticket_transferred', ...)
```

---

### **ุงูุณููุงุฑูู 6: ุนููู ูุฏูู ูุฑุณู ุฑุณุงูุฉ ุฌุฏูุฏุฉ**

```
1. ุงุณุชูุจุงู ุฑุณุงูุฉ ูู 01012345678
   โโโ "ูุญุชุงุฌ ููุณ ุงูุฏูุงุก ูุฑุฉ ุชุงููุฉ"

2. ุงูุชุญูู ูู ุงูุนููู
   โโโ Query: SELECT * FROM customers WHERE phone_number = ?
   โโโ ุงููุชูุฌุฉ: ููุฌูุฏ (customer_id = 123)
   โโโ ูุฏูู ุชุฐูุฑุฉ ุณุงุจูุฉ #789 (ูุบููุฉ ููุฐ 3 ุฃูุงู)

3. ูุชุญ ุชุฐูุฑุฉ ุฌุฏูุฏุฉ
   โโโ ูุง ูุชู ุฅุนุงุฏุฉ ูุชุญ ุงูุชุฐูุฑุฉ ุงููุฏููุฉ
   โโโ ูุชู ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ #850

4. ุงุฎุชูุงุฑ ุงูููุธู
   โโโ ุงูุฎูุงุฑ 1: ููุณ ุงูููุธู ุงูุณุงุจู (ุฃุญูุฏ) - ุฅุฐุง ูุชุงุญ
   โโโ ุงูุฎูุงุฑ 2: ููุธู ุขุฎุฑ - ุญุณุจ ุงูุญูู
   โโโ ุงููุฑุงุฑ: ุญุณุจ ุฅุนุฏุงุฏุงุช ุงููุธุงู

5. ุฅูุดุงุก ุงูุชุฐูุฑุฉ ุงูุฌุฏูุฏุฉ
   โโโ ููุณ ุฎุทูุงุช ุงูุณููุงุฑูู 1

6. ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู
   โโโ UPDATE customers SET
   โโโ last_contact_date = NOW()
   โโโ total_tickets_count++
```

---

## ๐ง **5. ุงูุนูููุงุช ูุงูู Queries ุงูุฃุณุงุณูุฉ**

### **ุงูุนูููุฉ 1: ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ**

```javascript
async function createNewTicket(phoneNumber, customerName, messageText) {
    // 1. ุงูุชุญูู ูู ุงูุนููู
    let customer = await db.query(
        'SELECT id FROM customers WHERE phone_number = ?',
        [phoneNumber]
    );

    if (!customer) {
        // ุฅูุดุงุก ุนููู ุฌุฏูุฏ
        customer = await db.query(
            `INSERT INTO customers (phone_number, wa_id, name, first_contact_date, last_contact_date)
             VALUES (?, ?, ?, NOW(), NOW())`,
            [phoneNumber, `${phoneNumber}@c.us`, customerName]
        );
    } else {
        // ุชุญุฏูุซ ุขุฎุฑ ุงุชุตุงู
        await db.query(
            'UPDATE customers SET last_contact_date = NOW(), total_tickets_count = total_tickets_count + 1 WHERE id = ?',
            [customer.id]
        );
    }

    // 2. ุงูุจุญุซ ุนู agent ูุชุงุญ
    const agent = await db.query(
        `SELECT a.id, a.current_active_tickets
         FROM agents a
         JOIN users u ON a.user_id = u.id
         WHERE a.is_online = TRUE
           AND a.status IN ('available', 'busy')
           AND a.current_active_tickets < 15
         ORDER BY a.current_active_tickets ASC
         LIMIT 1`
    );

    if (!agent) {
        throw new Error('No available agents');
    }

    // 3. ุฅูุดุงุก ุงูุชุฐูุฑุฉ
    const ticketNumber = `TKT-${new Date().getFullYear()}-${String(nextId).padStart(6, '0')}`;
    const ticket = await db.query(
        `INSERT INTO tickets (ticket_number, customer_id, assigned_agent_id, status, created_at, last_customer_message_at)
         VALUES (?, ?, ?, 'open', NOW(), NOW())`,
        [ticketNumber, customer.id, agent.id]
    );

    // 4. ุฅุถุงูุฉ ุงูุฑุณุงูุฉ
    await db.query(
        `INSERT INTO messages (ticket_id, sender_type, message_text, created_at)
         VALUES (?, 'customer', ?, NOW())`,
        [ticket.id, messageText]
    );

    // 5. ุชุญุฏูุซ ุนุฏุงุฏ ุงูุฑุณุงุฆู
    await db.query(
        'UPDATE tickets SET messages_count = messages_count + 1 WHERE id = ?',
        [ticket.id]
    );

    // 6. ุชุญุฏูุซ ุญุงูุฉ Agent
    await db.query(
        `UPDATE agents SET
            current_active_tickets = current_active_tickets + 1,
            status = CASE WHEN current_active_tickets + 1 >= 15 THEN 'busy' ELSE 'available' END
         WHERE id = ?`,
        [agent.id]
    );

    // 7. ุฅุฑุณุงู ุฅุดุนุงุฑ
    io.to(`agent-${agent.id}`).emit('new_ticket', {
        ticketId: ticket.id,
        ticketNumber: ticketNumber,
        customerName: customerName,
        message: messageText
    });

    // 8. ุจุฏุก Timer
    setTimeout(() => checkDelayedTicket(ticket.id), 180000);

    return ticket;
}
```

---

### **ุงูุนูููุฉ 2: Agent ูุฑุฏ ุนูู ุฑุณุงูุฉ**

```javascript
async function agentReply(ticketId, agentId, messageText) {
    // 1. ุฅุถุงูุฉ ุฑุณุงูุฉ Agent
    await db.query(
        `INSERT INTO messages (ticket_id, sender_id, sender_type, message_text, created_at)
         VALUES (?, ?, 'agent', ?, NOW())`,
        [ticketId, agentId, messageText]
    );

    // 2. ุงูุชุญูู ูู ุฃูู ุฑุฏ
    const ticket = await db.query(
        'SELECT first_response_at, created_at FROM tickets WHERE id = ?',
        [ticketId]
    );

    if (!ticket.first_response_at) {
        // ุญุณุงุจ Response Time
        const responseTime = Math.floor((Date.now() - new Date(ticket.created_at)) / 1000);

        await db.query(
            `UPDATE tickets SET
                first_response_at = NOW(),
                response_time_seconds = ?,
                status = 'in_progress',
                is_delayed = FALSE
             WHERE id = ?`,
            [responseTime, ticketId]
        );

        // ุชุณุฌูู ูู response_time_tracking
        await db.query(
            `INSERT INTO response_time_tracking (ticket_id, agent_id, message_received_at, first_response_at, response_time_seconds, is_delayed)
             VALUES (?, ?, ?, NOW(), ?, ?)`,
            [ticketId, agentId, ticket.created_at, responseTime, responseTime > 180]
        );
    }

    // 3. ุชุญุฏูุซ ุนุฏุงุฏุงุช
    await db.query(
        'UPDATE tickets SET messages_count = messages_count + 1, last_agent_message_at = NOW() WHERE id = ?',
        [ticketId]
    );

    // 4. ุชุญุฏูุซ KPI
    await db.query(
        `INSERT INTO agent_kpi (agent_id, kpi_date, messages_sent)
         VALUES (?, CURDATE(), 1)
         ON DUPLICATE KEY UPDATE messages_sent = messages_sent + 1`,
        [agentId]
    );
}
```

---

### **ุงูุนูููุฉ 3: ูุดู ุงูุชุฃุฎูุฑ (Cron Job)**

```javascript
// ูุนูู ูู ุฏูููุฉ
async function checkDelayedTickets() {
    // 1. ุงูุจุญุซ ุนู ุชุฐุงูุฑ ูุชุฃุฎุฑุฉ
    const delayedTickets = await db.query(
        `SELECT id, ticket_number, assigned_agent_id
         FROM tickets
         WHERE status IN ('new', 'open', 'in_progress')
           AND first_response_at IS NULL
           AND TIMESTAMPDIFF(SECOND, last_customer_message_at, NOW()) > 180`
    );

    for (const ticket of delayedTickets) {
        // 2. ุชุญุฏูุซ ุงูุชุฐูุฑุฉ
        await db.query(
            `UPDATE tickets SET
                is_delayed = TRUE,
                status = 'pending',
                delay_count = delay_count + 1
             WHERE id = ?`,
            [ticket.id]
        );

        // 3. ุชุณุฌูู ุญุฏุซ ุงูุชุฃุฎูุฑ
        await db.query(
            `INSERT INTO agent_delay_events (ticket_id, agent_id, delay_start_time)
             VALUES (?, ?, NOW())`,
            [ticket.id, ticket.assigned_agent_id]
        );

        // 4. ุชุญุฏูุซ KPI
        await db.query(
            `UPDATE agent_kpi SET delay_count = delay_count + 1
             WHERE agent_id = ? AND kpi_date = CURDATE()`,
            [ticket.assigned_agent_id]
        );

        // 5. ุฅุดุนุงุฑ ููู Admin
        io.to('admin').emit('agent_delay', {
            ticketId: ticket.id,
            ticketNumber: ticket.ticket_number,
            agentId: ticket.assigned_agent_id
        });
    }
}
```

---

## ๏ฟฝ **6. Queries ุงูุจุญุซ ูุงูููุชุฑุฉ ุงููุชูุฏูุฉ**

### **๐ฏ ุงูุจุญุซ ูุซู WhatsApp Web - ููููุธู**

#### **6.1 ุงูุจุญุซ ูู ูุญุงุฏุซุงุชู (ุจุงูุงุณู ุฃู ุงูุฑูู ุฃู ุงูุฑุณุงูุฉ)**

```sql
-- ุงูุจุญุซ ุงูุดุงูู ูู ูุญุงุฏุซุงุช ุงูููุธู
-- ูุจุญุซ ูู: ุงุณู ุงูุนูููุ ุฑูู ุงููุงุชูุ ูุญุชูู ุงูุฑุณุงุฆู
SELECT DISTINCT
    t.id as ticket_id,
    t.ticket_number,
    t.status,
    c.id as customer_id,
    c.name as customer_name,
    c.phone_number,
    t.created_at,
    t.last_message_at,

    -- ุขุฎุฑ ุฑุณุงูุฉ ูู ุงููุญุงุฏุซุฉ
    (SELECT m.message_text
     FROM messages m
     WHERE m.ticket_id = t.id
     ORDER BY m.created_at DESC
     LIMIT 1) as last_message,

    -- ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ (ูู ุงูุนููู)
    (SELECT COUNT(*)
     FROM messages m
     WHERE m.ticket_id = t.id
       AND m.sender_type = 'customer'
       AND m.is_read = FALSE) as unread_count,

    -- ุนุฏุฏ ุงูุฑุณุงุฆู ุงูุชู ุชุญุชูู ุนูู ูููุฉ ุงูุจุญุซ
    (SELECT COUNT(*)
     FROM messages m
     WHERE m.ticket_id = t.id
       AND m.message_text LIKE CONCAT('%', ?, '%')) as match_count

FROM tickets t
JOIN customers c ON t.customer_id = c.id
LEFT JOIN messages m ON t.id = m.ticket_id

WHERE t.assigned_agent_id = ?  -- ุงูููุธู ุงูุญุงูู ููุท
  AND (
      -- ุงูุจุญุซ ูู ุงุณู ุงูุนููู
      c.name LIKE CONCAT('%', ?, '%')

      -- ุฃู ุงูุจุญุซ ูู ุฑูู ุงููุงุชู
      OR c.phone_number LIKE CONCAT('%', ?, '%')

      -- ุฃู ุงูุจุญุซ ูู ูุญุชูู ุงูุฑุณุงุฆู
      OR m.message_text LIKE CONCAT('%', ?, '%')
  )

GROUP BY t.id
ORDER BY
    -- ุงูุฃููููุฉ: ุงููุญุงุฏุซุงุช ุงูุชู ูููุง ุชุทุงุจู ุฃูุซุฑ
    match_count DESC,
    -- ุซู ุงูุฃุญุฏุซ
    t.last_message_at DESC

LIMIT 50;
```

**ูุซุงู ุงุณุชุฎุฏุงู:**
```javascript
// ุงูุจุญุซ ุนู "ุจูุงุฏูู"
const searchTerm = 'ุจูุงุฏูู';
const agentId = 5;

const results = await db.query(searchQuery, [
    searchTerm,  // ููุนุฏ
    agentId,     // ุงูููุธู
    searchTerm,  // ุงุณู ุงูุนููู
    searchTerm,  // ุฑูู ุงููุงุชู
    searchTerm   // ูุญุชูู ุงูุฑุณุงูุฉ
]);

// ุงููุชูุฌุฉ:
// [
//   {
//     ticket_id: 123,
//     customer_name: "ูุญูุฏ ุนูู",
//     phone_number: "01012345678",
//     last_message: "ูุญุชุงุฌ ุจูุงุฏูู ุงูุณุชุฑุง",
//     match_count: 3,  // 3 ุฑุณุงุฆู ุชุญุชูู "ุจูุงุฏูู"
//     unread_count: 1
//   },
//   {
//     ticket_id: 456,
//     customer_name: "ุฃุญูุฏ ุญุณู",
//     last_message: "ุจูุงุฏูู ุฃุฏูุงูุณ ูุชููุฑุ",
//     match_count: 2,
//     unread_count: 0
//   }
// ]
```

---

#### **6.2 ุงูุจุญุซ ุฏุงุฎู ูุญุงุฏุซุฉ ูุนููุฉ**

```sql
-- ุงูุจุญุซ ูู ุฑุณุงุฆู ูุญุงุฏุซุฉ ูุงุญุฏุฉ (ูุซู WhatsApp Web)
SELECT
    m.id,
    m.message_text,
    m.sender_type,
    m.created_at,

    -- ูุนูููุงุช ุงููุฑุณู
    CASE
        WHEN m.sender_type = 'customer' THEN c.name
        WHEN m.sender_type = 'agent' THEN u.full_name
        ELSE 'System'
    END as sender_name,

    -- ูู ุงูุฑุณุงูุฉ ุชุญุชูู ุนูู ูููุฉ ุงูุจุญุซ
    CASE
        WHEN m.message_text LIKE CONCAT('%', ?, '%') THEN TRUE
        ELSE FALSE
    END as is_match

FROM messages m
JOIN tickets t ON m.ticket_id = t.id
JOIN customers c ON t.customer_id = c.id
LEFT JOIN users u ON m.sender_id = u.id

WHERE t.id = ?  -- ุงููุญุงุฏุซุฉ ุงููุญุฏุฏุฉ
  AND t.assigned_agent_id = ?  -- ุชุฃูุฏ ุฃููุง ููููุธู ุงูุญุงูู
  AND m.message_text LIKE CONCAT('%', ?, '%')  -- ูููุฉ ุงูุจุญุซ

ORDER BY m.created_at ASC;
```

---

#### **6.3 ุงูุชุฑุงุญุงุช ุงูุจุญุซ (Auto-complete)**

```sql
-- ุงูุชุฑุงุญุงุช ุฃุซูุงุก ุงููุชุงุจุฉ (ูุซู WhatsApp Web)
-- ูุนุฑุถ: ุฃุณูุงุก ุงูุนููุงุก + ุฃุฑูุงู + ูููุงุช ุดุงุฆุนุฉ

-- ุงูุฌุฒุก 1: ุฃุณูุงุก ุงูุนููุงุก
(SELECT DISTINCT
    c.name as suggestion,
    'customer_name' as type,
    COUNT(t.id) as relevance
FROM customers c
JOIN tickets t ON c.id = t.customer_id
WHERE t.assigned_agent_id = ?
  AND c.name LIKE CONCAT(?, '%')
GROUP BY c.id
ORDER BY relevance DESC
LIMIT 5)

UNION ALL

-- ุงูุฌุฒุก 2: ุฃุฑูุงู ุงูููุงุชู
(SELECT DISTINCT
    c.phone_number as suggestion,
    'phone_number' as type,
    COUNT(t.id) as relevance
FROM customers c
JOIN tickets t ON c.id = t.customer_id
WHERE t.assigned_agent_id = ?
  AND c.phone_number LIKE CONCAT(?, '%')
GROUP BY c.id
ORDER BY relevance DESC
LIMIT 5)

UNION ALL

-- ุงูุฌุฒุก 3: ูููุงุช ุดุงุฆุนุฉ ูู ุงูุฑุณุงุฆู
(SELECT DISTINCT
    SUBSTRING_INDEX(SUBSTRING_INDEX(m.message_text, ' ', numbers.n), ' ', -1) as suggestion,
    'message_keyword' as type,
    COUNT(*) as relevance
FROM messages m
JOIN tickets t ON m.ticket_id = t.id
CROSS JOIN (
    SELECT 1 n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5
) numbers
WHERE t.assigned_agent_id = ?
  AND CHAR_LENGTH(m.message_text) - CHAR_LENGTH(REPLACE(m.message_text, ' ', '')) >= numbers.n - 1
  AND SUBSTRING_INDEX(SUBSTRING_INDEX(m.message_text, ' ', numbers.n), ' ', -1) LIKE CONCAT(?, '%')
  AND CHAR_LENGTH(SUBSTRING_INDEX(SUBSTRING_INDEX(m.message_text, ' ', numbers.n), ' ', -1)) > 2
GROUP BY suggestion
HAVING COUNT(*) > 2  -- ูููุงุช ุชูุฑุฑุช ุฃูุซุฑ ูู ูุฑุชูู
ORDER BY relevance DESC
LIMIT 5)

ORDER BY relevance DESC
LIMIT 10;
```

---

#### **6.4 ููุชุฑุฉ ุงููุญุงุฏุซุงุช (ูุซู WhatsApp Web)**

```sql
-- ููุชุฑุฉ ูุญุงุฏุซุงุช ุงูููุธู
SELECT
    t.id,
    t.ticket_number,
    t.status,
    c.name,
    c.phone_number,
    t.created_at,
    t.last_message_at,

    -- ุขุฎุฑ ุฑุณุงูุฉ
    (SELECT m.message_text
     FROM messages m
     WHERE m.ticket_id = t.id
     ORDER BY m.created_at DESC
     LIMIT 1) as last_message,

    -- ุนุฏุฏ ุบูุฑ ุงูููุฑูุกุฉ
    (SELECT COUNT(*)
     FROM messages m
     WHERE m.ticket_id = t.id
       AND m.sender_type = 'customer'
       AND m.is_read = FALSE) as unread_count,

    -- Tags
    (SELECT GROUP_CONCAT(tag)
     FROM customer_tags
     WHERE customer_id = c.id) as tags

FROM tickets t
JOIN customers c ON t.customer_id = c.id

WHERE t.assigned_agent_id = ?

  -- ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ (ุงุฎุชูุงุฑู)
  AND (? IS NULL OR t.status = ?)

  -- ููุชุฑุฉ ุญุณุจ ุงููุฆุฉ (ุงุฎุชูุงุฑู)
  AND (? IS NULL OR t.category = ?)

  -- ููุชุฑุฉ ุญุณุจ ุงูุฃููููุฉ (ุงุฎุชูุงุฑู)
  AND (? IS NULL OR t.priority = ?)

  -- ููุชุฑุฉ: ุบูุฑ ููุฑูุกุฉ ููุท (ุงุฎุชูุงุฑู)
  AND (? = FALSE OR EXISTS (
      SELECT 1 FROM messages m
      WHERE m.ticket_id = t.id
        AND m.sender_type = 'customer'
        AND m.is_read = FALSE
  ))

  -- ููุชุฑุฉ: ูุชุฃุฎุฑุฉ ููุท (ุงุฎุชูุงุฑู)
  AND (? = FALSE OR t.status = 'delayed')

ORDER BY
    -- ุงูุฃููููุฉ: ุบูุฑ ุงูููุฑูุกุฉ ุฃููุงู
    unread_count DESC,
    -- ุซู ุงููุชุฃุฎุฑุฉ
    CASE WHEN t.status = 'delayed' THEN 0 ELSE 1 END,
    -- ุซู ุงูุฃุญุฏุซ
    t.last_message_at DESC;
```

**ูุซุงู ุงุณุชุฎุฏุงู:**
```javascript
// ููุชุฑุฉ: ููุชูุญุฉ + ุบูุฑ ููุฑูุกุฉ ููุท
const filters = {
    agentId: 5,
    status: 'open',      // ุฃู NULL ูููู
    category: null,      // NULL = ุงููู
    priority: null,
    unreadOnly: true,    // ููุท ุบูุฑ ุงูููุฑูุกุฉ
    delayedOnly: false
};

const results = await db.query(filterQuery, [
    filters.agentId,
    filters.status, filters.status,
    filters.category, filters.category,
    filters.priority, filters.priority,
    filters.unreadOnly,
    filters.delayedOnly
]);
```

---

#### **6.5 ุชุญุฏูุซ ุญุงูุฉ "ููุฑูุกุฉ" ููุฑุณุงุฆู**

```sql
-- ุนูุฏ ูุชุญ ูุญุงุฏุซุฉุ ุชุญุฏูุซ ุงูุฑุณุงุฆู ูู "ููุฑูุกุฉ"
UPDATE messages m
JOIN tickets t ON m.ticket_id = t.id
SET m.is_read = TRUE,
    m.read_at = NOW()
WHERE t.id = ?
  AND t.assigned_agent_id = ?  -- ุชุฃูุฏ ุฃููุง ููููุธู
  AND m.sender_type = 'customer'
  AND m.is_read = FALSE;
```

---

### **๐ Queries ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช**

#### **6.6 ุชูุฑูุฑ ุฃุฏุงุก ุงูููุธููู - ูููู**

```sql
-- ููุงุฑูุฉ ุฃุฏุงุก ุฌููุน ุงูููุธููู ุงูููู
SELECT
    u.full_name as agent_name,
    a.status as current_status,
    a.current_active_tickets,

    -- ุฅุญุตุงุฆูุงุช ุงูููู
    COUNT(t.id) as total_tickets_today,
    COUNT(CASE WHEN t.status = 'closed' THEN 1 END) as closed_today,
    COUNT(CASE WHEN t.status = 'delayed' THEN 1 END) as delayed_today,

    -- ูุชูุณุท ููุช ุงูุฑุฏ
    AVG(CASE
        WHEN t.first_response_at IS NOT NULL
        THEN t.response_time_seconds
    END) as avg_response_time,

    -- ุฅุฌูุงูู ุฏูุงุฆู ุงูุชุฃุฎูุฑ
    SUM(COALESCE(t.total_delay_minutes, 0)) as total_delay_minutes,

    -- Quality Score
    ROUND(
        COUNT(CASE WHEN t.response_time_seconds <= 180 THEN 1 END) * 100.0 /
        NULLIF(COUNT(CASE WHEN t.first_response_at IS NOT NULL THEN 1 END), 0),
        2
    ) as quality_score_percentage,

    -- ูุชูุณุท ุงูุชูููู
    AVG(cs.rating) as avg_customer_rating

FROM agents a
JOIN users u ON a.user_id = u.id
LEFT JOIN tickets t ON a.id = t.assigned_agent_id
    AND DATE(t.created_at) = CURDATE()
LEFT JOIN customer_satisfaction cs ON t.id = cs.ticket_id

WHERE a.is_active = TRUE

GROUP BY a.id, u.full_name, a.status, a.current_active_tickets
ORDER BY quality_score_percentage DESC, total_tickets_today DESC;
```

---

#### **6.7 ุญูู ุงูุนูู ุงูุญุงูู (Real-time Dashboard)**

```sql
-- ุญุงูุฉ ุงูููุธููู ุงูุขู
SELECT
    u.full_name,
    a.status,
    a.is_online,
    a.current_active_tickets,
    a.max_capacity,

    -- ูุณุจุฉ ุงูุงุณุชุฎุฏุงู
    ROUND((a.current_active_tickets * 100.0 / a.max_capacity), 2) as utilization_percentage,

    -- ุงูุชุฐุงูุฑ ุงููุชุฃุฎุฑุฉ ุงูุขู
    COUNT(CASE WHEN t.status = 'delayed' THEN 1 END) as delayed_now,

    -- ุงูุชุฐุงูุฑ ุงูููุชูุญุฉ
    COUNT(CASE WHEN t.status = 'open' THEN 1 END) as open_now,

    -- ุขุฎุฑ ูุดุงุท
    MAX(t.last_message_at) as last_activity

FROM agents a
JOIN users u ON a.user_id = u.id
LEFT JOIN tickets t ON a.id = t.assigned_agent_id
    AND t.status IN ('open', 'delayed')

WHERE a.is_active = TRUE

GROUP BY a.id, u.full_name, a.status, a.is_online,
         a.current_active_tickets, a.max_capacity

ORDER BY utilization_percentage DESC;
```

---

#### **6.8 ุงูุนููุงุก ุงูุฃูุซุฑ ูุดุงุทุงู**

```sql
-- ุฃูุซุฑ 20 ุนููู ุชูุงุตูุงู
SELECT
    c.id,
    c.name,
    c.phone_number,
    c.first_contact_date,
    c.last_contact_date,

    -- ุนุฏุฏ ุงูุชุฐุงูุฑ
    COUNT(DISTINCT t.id) as total_tickets,

    -- ุนุฏุฏ ุงูุฑุณุงุฆู
    COUNT(DISTINCT m.id) as total_messages,

    -- ูุชูุณุท ุงูุชูููู
    AVG(cs.rating) as avg_rating,

    -- Tags
    GROUP_CONCAT(DISTINCT ct.tag) as tags,

    -- ุขุฎุฑ ูุญุงุฏุซุฉ
    MAX(t.created_at) as last_ticket_date

FROM customers c
LEFT JOIN tickets t ON c.id = t.customer_id
LEFT JOIN messages m ON t.id = m.ticket_id
LEFT JOIN customer_satisfaction cs ON t.id = cs.ticket_id
LEFT JOIN customer_tags ct ON c.id = ct.customer_id

GROUP BY c.id
ORDER BY total_tickets DESC, total_messages DESC
LIMIT 20;
```

---

#### **6.9 ุณุงุนุงุช ุงูุฐุฑูุฉ (Peak Hours)**

```sql
-- ูุนุฑูุฉ ุฃูุซุฑ ุงูุณุงุนุงุช ุงุฒุฏุญุงูุงู
SELECT
    HOUR(t.created_at) as hour_of_day,
    COUNT(*) as ticket_count,
    AVG(t.response_time_seconds) as avg_response_time,
    COUNT(CASE WHEN t.status = 'delayed' THEN 1 END) as delayed_count,

    -- ูุณุจุฉ ุงูุชุฃุฎูุฑ
    ROUND(
        COUNT(CASE WHEN t.status = 'delayed' THEN 1 END) * 100.0 / COUNT(*),
        2
    ) as delay_percentage

FROM tickets t
WHERE DATE(t.created_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)

GROUP BY hour_of_day
ORDER BY ticket_count DESC;
```

---

#### **6.10 ุฑุถุง ุงูุนููุงุก ุญุณุจ ุงูููุธู**

```sql
-- ุชูููู ุฑุถุง ุงูุนููุงุก
SELECT
    u.full_name as agent_name,

    -- ุนุฏุฏ ุงูุชููููุงุช
    COUNT(cs.id) as total_ratings,

    -- ูุชูุณุท ุงูุชูููู
    ROUND(AVG(cs.rating), 2) as avg_rating,

    -- ุชูุฒูุน ุงูุชููููุงุช
    COUNT(CASE WHEN cs.rating = 5 THEN 1 END) as five_stars,
    COUNT(CASE WHEN cs.rating = 4 THEN 1 END) as four_stars,
    COUNT(CASE WHEN cs.rating = 3 THEN 1 END) as three_stars,
    COUNT(CASE WHEN cs.rating = 2 THEN 1 END) as two_stars,
    COUNT(CASE WHEN cs.rating = 1 THEN 1 END) as one_star,

    -- ูุณุจุฉ ุงูุฑุถุง (4 ู 5 ูุฌูู)
    ROUND(
        COUNT(CASE WHEN cs.rating >= 4 THEN 1 END) * 100.0 /
        NULLIF(COUNT(cs.id), 0),
        2
    ) as satisfaction_percentage

FROM agents a
JOIN users u ON a.user_id = u.id
LEFT JOIN customer_satisfaction cs ON a.id = cs.agent_id
    AND DATE(cs.created_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)

WHERE a.is_active = TRUE

GROUP BY a.id, u.full_name
ORDER BY avg_rating DESC, total_ratings DESC;
```

---

## ๏ฟฝ๐ **7. ูุคุดุฑุงุช ุงูุฃุฏุงุก (KPIs)**

### **ููู Agent:**

#### **1. First Response Time (FRT)**
```sql
-- ูุชูุณุท ููุช ุฃูู ุฑุฏ
SELECT AVG(response_time_seconds) as avg_frt
FROM tickets
WHERE assigned_agent_id = ?
  AND first_response_at IS NOT NULL
  AND DATE(created_at) = CURDATE();
```

#### **2. Total Tickets Handled**
```sql
SELECT COUNT(*) as total_tickets
FROM tickets
WHERE assigned_agent_id = ?
  AND DATE(created_at) = CURDATE();
```

#### **3. Delayed Responses**
```sql
SELECT COUNT(*) as delayed_count
FROM tickets
WHERE assigned_agent_id = ?
  AND is_delayed = TRUE
  AND DATE(created_at) = CURDATE();
```

#### **4. Quality Score**
```sql
SELECT
    (COUNT(*) FILTER (WHERE response_time_seconds <= 180) * 100.0 / COUNT(*)) as quality_score
FROM tickets
WHERE assigned_agent_id = ?
  AND first_response_at IS NOT NULL
  AND DATE(created_at) = CURDATE();
```

---

### **ูููุธุงู:**

#### **Dashboard Stats**
```sql
-- ุฅุญุตุงุฆูุงุช ุงูููู
SELECT
    COUNT(*) FILTER (WHERE status IN ('new', 'open', 'in_progress', 'pending')) as active_tickets,
    COUNT(*) FILTER (WHERE status = 'closed' AND DATE(closed_at) = CURDATE()) as closed_today,
    COUNT(*) FILTER (WHERE is_delayed = TRUE) as delayed_tickets,
    AVG(response_time_seconds) as avg_response_time
FROM tickets
WHERE DATE(created_at) = CURDATE();
```

---
## ๐จ **8. ูุงุฌูุงุช ุงููุณุชุฎุฏู (UI Wireframes)**

### **ูุงุฌูุฉ Admin - Dashboard**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฅ ุตูุฏููุงุช ุฎูููุฉ - ููุญุฉ ุงูุชุญูู                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                             โ
โ  ๐ ุฅุญุตุงุฆูุงุช ุงูููู                                          โ
โ  โโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโ              โ
โ  โ ูุดุทุฉ     โ ูุบููุฉ    โ ูุชุฃุฎุฑุฉ   โ ูุชูุณุท ุงูุฑุฏโ              โ
โ  โ   24     โ   156    โ    3     โ  2.5 ุฏู  โ              โ
โ  โโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโ              โ
โ                                                             โ
โ  ๐ฅ ุงูููุธููู (15)                                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ โ ุฃุญูุฏ ูุญูุฏ      โ 8 ุชุฐุงูุฑ  โ 2.1 ุฏู โ [ุนุฑุถ]     โ    โ
โ  โ โ ูุงุทูุฉ ุนูู      โ 10 ุชุฐุงูุฑ โ 2.8 ุฏู โ [ุนุฑุถ]     โ    โ
โ  โ ๐ด ุนูู ุญุณู (ุชุฃุฎูุฑ)โ 12 ุชุฐุงูุฑ โ 4.2 ุฏู โ [ุชุญููู]   โ    โ
โ  โ โช ุณุงุฑุฉ ุฃุญูุฏ       โ 0 ุชุฐุงูุฑ  โ -      โ [Offline] โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                             โ
โ  ๐ ุฅุฏุฎุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ (ุงููุฑุญูุฉ 1)                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ุฑูู ุงููุงุชู: [_______________]                       โ    โ
โ  โ ุงูุงุณู: [_______________]                            โ    โ
โ  โ ุงูุฑุณุงูุฉ: [_____________________________]            โ    โ
โ  โ          [_____________________________]            โ    โ
โ  โ                                    [ุฅุฑุณุงู]          โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### **ูุงุฌูุฉ Agent - ูุงุฆูุฉ ุงูุชุฐุงูุฑ**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค ุฃุญูุฏ ูุญูุฏ - ุชุฐุงูุฑู (8)                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                             โ
โ  ๐ ุฌุฏูุฏุฉ (2)                                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ๐ด TKT-2025-000789 โ ูุญูุฏ ุนูู    โ ููุฐ ุฏูููุชูู      โ    โ
โ  โ    "ูุญุชุงุฌ ุฏูุงุก ููุถุบุท"                               โ    โ
โ  โ                                          [ูุชุญ] [โ]  โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค    โ
โ  โ ๐ก TKT-2025-000790 โ ุณุงุฑุฉ ุฃุญูุฏ   โ ููุฐ 5 ุฏูุงุฆู      โ    โ
โ  โ    "ุงุณุชูุณุงุฑ ุนู ุณุนุฑ"                                 โ    โ
โ  โ                                          [ูุชุญ] [โ]  โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                             โ
โ  ๐ฌ ููุฏ ุงููุนุงูุฌุฉ (6)                                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ๐ข TKT-2025-000785 โ ุนูู ุญุณู     โ ููุฐ 10 ุฏูููุฉ     โ    โ
โ  โ    "ุดูุฑุงูุ ูู ูุชููุฑุ"                               โ    โ
โ  โ                                          [ูุชุญ] [โ]  โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### **ูุงุฌูุฉ Agent - ุงููุญุงุฏุซุฉ** ๐ฌ **(ูุซู WhatsApp Web)**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โโ Header โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ค ูุญูุฏ ุนูู                                    ๐ 01012345678      โ โ
โ โ TKT-2025-000789 โ โ ูุดุทุฉ โ ููุฐ 5 ุฏูุงุฆู                           โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                         โ
โ โโ Chat Area โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ                                                                     โ โ
โ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                   โ โ
โ โ  โ ูุญุชุงุฌ ุฏูุงุก ููุถุบุท            โ  ๐ค ูุญูุฏ ุนูู                      โ โ
โ โ  โ                       10:30 โ                                   โ โ
โ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                   โ โ
โ โ                                                                     โ โ
โ โ                                   ุฃูุช (ุฃุญูุฏ) ๐จโ๐ผ                   โ โ
โ โ                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ โ
โ โ                                   โ ุฃููุงู ุจูุ ุฃู ููุน ุชุญุฏูุฏุงูุ   โ  โ โ
โ โ                                   โ 10:32                       โ  โ โ
โ โ                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ โ
โ โ                                                                     โ โ
โ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                   โ โ
โ โ  โ ูููููุฑ 5 ููุฌู               โ  ๐ค ูุญูุฏ ุนูู                      โ โ
โ โ  โ                       10:33 โ                                   โ โ
โ โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                   โ โ
โ โ                                                                     โ โ
โ โ                                   ุฃูุช (ุฃุญูุฏ) ๐จโ๐ผ                   โ โ
โ โ                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ โ
โ โ                                   โ ูุชููุฑุ ุงูุณุนุฑ 45 ุฌููู        โ  โ โ
โ โ                                   โ 10:34 โโ                    โ  โ โ
โ โ                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ โ
โ โ                                                                     โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                         โ
โ โโ Input Area โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ                                                                     โ โ
โ โ ๐  ๐  ๐                                                          โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ โ โ ุงูุชุจ ุฑุณุงูุฉ...                                                   โ โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ โ                                                                     โ โ
โ โ [๐ ููุงูุจู ุงูุฎุงุตุฉ โผ]                    [ุฅุฑุณุงู โ๏ธ] [ุฅููุงุก โ]      โ โ
โ โ                                                                     โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุฃููุงู:
- ุฑุณุงุฆู ุงูุนููู: ุฎูููุฉ ุจูุถุงุก (ูุณุงุฑ)
- ุฑุณุงุฆู ุงูููุธู: ุฎูููุฉ ุฎุถุฑุงุก ูุงุชุญุฉ (ูููู)
- โโ = ุชู ุงูุฅุฑุณุงู
```

---

## ๏ฟฝ **9. ุตูุงุญูุงุช ุงููุณุชุฎุฏููู (Admin vs Agent)**

### **๐ Admin (ุงููุฏูุฑ) - ุตูุงุญูุงุช ูุงููุฉ**

#### **ุงูุตูุญุงุช ุงููุชุงุญุฉ:**
```
1. ๐ Dashboard ุงูุฑุฆูุณู
   โโโ ุฅุญุตุงุฆูุงุช ุงูููู (ูุดุทุฉุ ูุบููุฉุ ูุชุฃุฎุฑุฉ)
   โโโ ูุงุฆูุฉ ุฌููุน ุงูููุธููู + ุญุงูุงุชูู
   โโโ ุงูุชุฐุงูุฑ ุงููุชุฃุฎุฑุฉ (ุชูุจููุงุช ุญูุฑุงุก)
   โโโ ุฅุฏุฎุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูุฏููุงู (ุงููุฑุญูุฉ 1)

2. ๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู
   โโโ ุนุฑุถ ุฌููุน ุงูููุธููู
   โโโ ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ
   โโโ ุชุนุฏูู ุจูุงูุงุช ููุธู
   โโโ ุชุนุทูู/ุชูุนูู ุญุณุงุจ
   โโโ ุนุฑุถ KPIs ููู ููุธู

3. ๐ซ ุฅุฏุงุฑุฉ ุงูุชุฐุงูุฑ
   โโโ ุนุฑุถ ุฌููุน ุงูุชุฐุงูุฑ (ุงููู)
   โโโ ุชุญููู ุชุฐูุฑุฉ ูู ููุธู ูุขุฎุฑ
   โโโ ุฅุบูุงู ุชุฐูุฑุฉ
   โโโ ุฅุนุงุฏุฉ ูุชุญ ุชุฐูุฑุฉ
   โโโ ุนุฑุถ ุชูุงุตูู ุฃู ูุญุงุฏุซุฉ

4. ๐ค ุฅุฏุงุฑุฉ ุงูุนููุงุก
   โโโ ุนุฑุถ ุฌููุน ุงูุนููุงุก
   โโโ ุฅุถุงูุฉ ููุงุญุธุงุช ุนูู ุนููู
   โโโ ุฅุถุงูุฉ Tags
   โโโ ุนุฑุถ ุชุงุฑูุฎ ุงููุญุงุฏุซุงุช

5. ๐ ุงูููุงูุจ
   โโโ ุนุฑุถ ุงูููุงูุจ ุงูุนุงูุฉ (ููุฌููุน)
   โโโ ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ููุงูุจ ุนุงูุฉ
   โโโ ุนุฑุถ ููุงูุจ ุงูููุธููู ุงูุดุฎุตูุฉ

6. ๐ ุงูุชูุงุฑูุฑ ูุงูู KPIs
   โโโ ุชูุงุฑูุฑ ููููุฉ
   โโโ ุชูุงุฑูุฑ ุดูุฑูุฉ
   โโโ KPIs ููู ููุธู
   โโโ KPIs ุงููุธุงู
   โโโ ุชุตุฏูุฑ Excel/PDF

7. ๐ Activity Log
   โโโ ุนุฑุถ ุฌููุน ุงูุฃูุดุทุฉ
   โโโ ููุชุฑุฉ ุญุณุจ ุงูููุธู/ุงูุชุงุฑูุฎ
   โโโ ุชุชุจุน ุงูุชุบููุฑุงุช
```

---

### **๐จโ๐ผ Agent (ุงูููุธู) - ุตูุงุญูุงุช ูุญุฏูุฏุฉ**

#### **ุงูุตูุญุงุช ุงููุชุงุญุฉ:**
```
1. ๐ฌ ูุญุงุฏุซุงุชู (ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ)
   โโโ ุนุฑุถ ุงูุชุฐุงูุฑ ุงููุฎุตุตุฉ ูู ููุท
   โโโ ููุชุฑุฉ: (ููุชูุญุฉุ ูุชุฃุฎุฑุฉุ ูุบููุฉ)
   โโโ ูุชุญ ูุญุงุฏุซุฉ
   โโโ ุงูุฑุฏ ุนูู ุงูุฑุณุงุฆู
   โโโ ุฅููุงุก ุงููุญุงุฏุซุฉ
   โโโ โ ูุง ูุณุชุทูุน ุฑุคูุฉ ุชุฐุงูุฑ ุงูุขุฎุฑูู

2. ๐ ููุงูุจู ุงูุฎุงุตุฉ
   โโโ ุนุฑุถ ููุงูุจู ุงูุดุฎุตูุฉ
   โโโ ุฅุถุงูุฉ ูุงูุจ ุฌุฏูุฏ
   โโโ ุชุนุฏูู ูุงูุจ
   โโโ ุญุฐู ูุงูุจ
   โโโ ุงุณุชุฎุฏุงู ุงูููุงูุจ ูู ุงูุฑุฏูุฏ

3. ๐ ุฃุฏุงุฆู (KPIs ุงูุฎุงุตุฉ ุจู)
   โโโ First Response Time
   โโโ Total Tickets Handled
   โโโ Delayed Count
   โโโ Quality Score
   โโโ โ ูุง ูุณุชุทูุน ุฑุคูุฉ ุฃุฏุงุก ุงูุขุฎุฑูู

4. โ ููููุน ูู:
   โโโ ุฑุคูุฉ ุชุฐุงูุฑ ุงูููุธููู ุงูุขุฎุฑูู
   โโโ ุชุญููู ุงูุชุฐุงูุฑ
   โโโ ุฅุฏุงุฑุฉ ุงูููุธููู
   โโโ ุฅุฏุงุฑุฉ ุงูุนููุงุก
   โโโ ุงูููุงูุจ ุงูุนุงูุฉ (ูุณุชุทูุน ุงุณุชุฎุฏุงููุง ููุท)
   โโโ Activity Log
```

---

### **๐ ุฌุฏูู ุงูููุงุฑูุฉ:**

| **ุงูููุฒุฉ** | **Admin** | **Agent** |
|------------|-----------|-----------|
| **Dashboard ุงูุฑุฆูุณู** | โ ูู ุดูุก | โ ูุง |
| **ูุญุงุฏุซุงุชู** | โ ุงููู | โ ุงูุฎุงุตุฉ ุจู ููุท |
| **ุชุญููู ุชุฐูุฑุฉ** | โ ูุนู | โ ูุง |
| **ุฅุฏุงุฑุฉ ููุธููู** | โ ูุนู | โ ูุง |
| **ููุงูุจ ุนุงูุฉ** | โ ุฅุถุงูุฉ/ุชุนุฏูู | โ ุงุณุชุฎุฏุงู ููุท |
| **ููุงูุจ ุดุฎุตูุฉ** | โ ุฑุคูุฉ ุงููู | โ ุงูุฎุงุตุฉ ุจู ููุท |
| **KPIs** | โ ุงููู | โ ุงูุฎุงุตุฉ ุจู ููุท |
| **ุชูุงุฑูุฑ** | โ ูุนู | โ ูุง |
| **Activity Log** | โ ูุนู | โ ูุง |

---

## ๏ฟฝ๐ **10. ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ**

### **ุงููุฑุญูุฉ 1 (MVP):**
```
Backend:
โโโ Python 3.10+
โโโ Django 4.2+
โโโ Django Channels (WebSocket ููู Real-time)
โโโ Celery + Redis (ููู Cron Jobs)

Database:
โโโ SQLite (ููุชุทููุฑ ูุงูุงุฎุชุจุงุฑ)
โโโ ุฌุงูุฒ ููุงูุชูุงู ูู PostgreSQL/MySQL

Frontend:
โโโ HTML5
โโโ CSS3 (Bootstrap 5 ุฃู Tailwind)
โโโ JavaScript (Vanilla - ุจุฏูู React/Vue)
โโโ WebSocket Client (ููู Real-time)

Authentication:
โโโ Django Authentication System
โโโ Django Sessions
```

### **ุงููุฑุญูุฉ 2 (Production):**
```
Database:
โโโ PostgreSQL 14+ (ุงูุฎูุงุฑ ุงูุฃูุถู)
โโโ ุฃู MySQL 8.0

WhatsApp:
โโโ WPPConnect (ุฎูุงุฑ 1 - ูุฌุงููุ ุณูู)
โโโ WhatsApp Cloud API (ุฎูุงุฑ 2 - ุฑุณููุ ูุฏููุน)

Additional:
โโโ Redis (Caching + Celery Broker)
โโโ Gunicorn + Daphne (ASGI Server)
โโโ Nginx (Reverse Proxy)
โโโ Supervisor (Process Manager)
```

### **ููุงุฐุง Django + SQLite ูู ุงูุจุฏุงูุฉุ**
```
โ Django:
   โโโ Admin Panel ุฌุงูุฒ (ุชูููุฑ ููุช)
   โโโ ORM ููู (ุณูููุฉ ุงูุชุนุงูู ูุน DB)
   โโโ Authentication ุฌุงูุฒ
   โโโ Forms & Validation ุฌุงูุฒุฉ
   โโโ ููุงุณุจ ูููุดุงุฑูุน ุงููุชูุณุทุฉ ูุงููุจูุฑุฉ

โ SQLite:
   โโโ ูุง ูุญุชุงุฌ ุชุซุจูุช (ููู ูุงุญุฏ)
   โโโ ุณุฑูุน ูู ุงูุชุทููุฑ
   โโโ ููุณ SQL ุชูุงูุงู
   โโโ ุงูุงูุชูุงู ูู PostgreSQL ุณูู ุฌุฏุงู:

       # ูู settings.py - ูุจู
       DATABASES = {
           'default': {
               'ENGINE': 'django.db.backends.sqlite3',
               'NAME': BASE_DIR / 'db.sqlite3',
           }
       }

       # ุจุนุฏ (PostgreSQL)
       DATABASES = {
           'default': {
               'ENGINE': 'django.db.backends.postgresql',
               'NAME': 'khalifa_db',
               'USER': 'postgres',
               'PASSWORD': 'password',
               'HOST': 'localhost',
               'PORT': '5432',
           }
       }
```

---

## โ **10. ูุนุงููุฑ ุงููุฌุงุญ**

### **ุงููุฑุญูุฉ 1:**
- [ ] Admin ูุณุชุทูุน ุฅุฏุฎุงู ุฑุณุงุฆู ูุฏููุงู
- [ ] ุงูุชูุฒูุน ุงูุฐูู ูุนูู ุจุดูู ุตุญูุญ
- [ ] Agent ูุณุชูุจู ุฅุดุนุงุฑุงุช ููุฑูุฉ
- [ ] ูุดู ุงูุชุฃุฎูุฑ ูุนูู (3 ุฏูุงุฆู)
- [ ] KPIs ุชูุญุณุจ ุจุฏูุฉ
- [ ] Dashboard ูุนุฑุถ ุงูุจูุงูุงุช Real-time

### **ุงููุฑุญูุฉ 2:**
- [ ] ุงุณุชูุจุงู ุฑุณุงุฆู WhatsApp ุงูุญููููุฉ
- [ ] ุฅุฑุณุงู ุฑุฏูุฏ ุนุจุฑ WhatsApp
- [ ] ูุนุงูุฌุฉ ุงููุณุงุฆุท (ุตูุฑุ ูููุงุช)
- [ ] ุงููุธุงู ูุนูู 24/7 ุจุฏูู ุฃุฎุทุงุก
- [ ] ุณุฑุนุฉ ุงูุฑุฏ < 1 ุซุงููุฉ
- [ ] ุฏุนู 100+ ูุญุงุฏุซุฉ ูุชุฒุงููุฉ

---

## ๐ **12. ููุงุญุธุงุช ูููุฉ**

### **ุงููุฑููุงุช ุจูู ุงููุฑุญูุชูู:**

| **ุงูููุฒุฉ** | **ุงููุฑุญูุฉ 1 (MVP)** | **ุงููุฑุญูุฉ 2 (Production)** |
|------------|---------------------|----------------------------|
| **Backend** | Django + SQLite | Django + PostgreSQL/MySQL |
| **Frontend** | HTML + CSS + JS (Vanilla) | ููุณู (ุฃู React ูุงุญูุงู) |
| **ุงุณุชูุจุงู ุงูุฑุณุงุฆู** | Admin ูุฏุฎู ูุฏููุงู | WhatsApp Webhook ุชููุงุฆู |
| **ุฅุฑุณุงู ุงูุฑุฏูุฏ** | ูุญุงูุงุฉ (ูุง ููุฑุณู ูุนููุงู) | ุฅุฑุณุงู ุญูููู ุนุจุฑ WhatsApp |
| **ุงูุนููุงุก** | ุจูุงูุงุช ุชุฌุฑูุจูุฉ | ุนููุงุก ุญูููููู |
| **ุงููุฏู** | ุงุฎุชุจุงุฑ ุงููุธุงู ุฏุงุฎููุงู | ุฎุฏูุฉ ุงูุนููุงุก ุงููุนููุฉ |
| **ุงููุฏุฉ** | 28 ููู | 17 ููู (8 WPPConnect + 9 Cloud API) |

---

### **โ๏ธ ููุงุท ูููุฉ ุฌุฏุงู:**

#### **1. ุญุงูุงุช ุงูุชุฐูุฑุฉ:**
```
โ OPEN (ููุชูุญุฉ):
   - ุนูุฏ ุงุณุชูุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
   - ุนูุฏ ุฑุฏ ุงูููุธู ุจุนุฏ ุงูุชุฃุฎูุฑ

โ DELAYED (ูุชุฃุฎุฑุฉ):
   - ุจุนุฏ 3 ุฏูุงุฆู ุจุฏูู ุฑุฏ
   - ููุญุณุจ ููุช ุงูุชุฃุฎูุฑ

โ CLOSED (ูุบููุฉ):
   - ุนูุฏ ุถุบุท "ุฅููุงุก ุงููุญุงุฏุซุฉ"
```

#### **2. ุงูุชุฃุฎูุฑ ููุญุณุจ ุญุชู ูู ุฑุฏ ุงูููุธู:**
```
โ๏ธ ูุซุงู:
   - ุฑุณุงูุฉ ูุตูุช: 10:30
   - ูุฑ 3 ุฏูุงุฆู: 10:33 โ DELAYED
   - ุงูููุธู ุฑุฏ: 10:37 (ุจุนุฏ 7 ุฏูุงุฆู)
   - ุงูุญุงูุฉ: OPEN (ุชุฑุฌุน ููุชูุญุฉ)
   - ููู: ููุณุฌู 4 ุฏูุงุฆู ุชุฃุฎูุฑ ุนูู ุงูููุธู
```

#### **3. ูุงุฌูุฉ ุงููุญุงุฏุซุฉ:**
```
โ ูุฌุจ ุฃู ุชููู ูุซู WhatsApp Web:
   - ุฑุณุงุฆู ุงูุนููู: ูุณุงุฑ (ุฎูููุฉ ุจูุถุงุก)
   - ุฑุณุงุฆู ุงูููุธู: ูููู (ุฎูููุฉ ุฎุถุฑุงุก)
   - Timestamps ูุงุถุญุฉ
   - Scroll ุชููุงุฆู ููุฃุณูู
   - Input area ุซุงุจุชุฉ ูู ุงูุฃุณูู
```

#### **4. ุตูุงุญูุงุช ุงูููุธู:**
```
โ ูุณุชุทูุน:
   - ุฑุคูุฉ ูุญุงุฏุซุงุชู ููุท
   - ุฅุฏุงุฑุฉ ููุงูุจู ุงูุดุฎุตูุฉ
   - ุฑุคูุฉ ุฃุฏุงุฆู ุงูุฎุงุต

โ ูุง ูุณุชุทูุน:
   - ุฑุคูุฉ ูุญุงุฏุซุงุช ุงูุขุฎุฑูู
   - ุชุญููู ุงูุชุฐุงูุฑ
   - ุฅุฏุงุฑุฉ ุงูููุธููู
```

---

## ๐ฏ **13. ุงูุฎุทูุงุช ุงูุชุงููุฉ**

### **ุงููุฑุญูุฉ ุงูุญุงููุฉ: ุงููุฑุงุฌุนุฉ ูุงูููุงูุดุฉ**

```
โ 1. ูุฑุงุฌุนุฉ ูุฐุง ุงูููู
   โโโ ููู ุฏูุฑุฉ ุญูุงุฉ ุงูุชุฐูุฑุฉ (OPEN โ DELAYED โ OPEN โ CLOSED)
   โโโ ููู ุงููุฑู ุจูู ุตูุงุญูุงุช Admin ู Agent
   โโโ ููู ุงูุชูููุงุช (Django + SQLite)
   โโโ ููู ูุงุฌูุฉ ุงููุญุงุฏุซุฉ (ูุซู WhatsApp Web)

โณ 2. ุงูููุงูุดุฉ ูุงูุชุนุฏููุงุช
   โโโ ูู ููุงู ุฃู ุชุนุฏููุงุชุ
   โโโ ูู ุงูุญุงูุงุช ูุงุถุญุฉุ
   โโโ ูู ุงูุตูุงุญูุงุช ููุงุณุจุฉุ

โณ 3. ุงูุจุฏุก ูู ุงูุชูููุฐ
   โโโ ุฅุนุฏุงุฏ Django Project
   โโโ ุฅูุดุงุก ุงูุฌุฏุงูู (Models)
   โโโ ุจูุงุก ุงููุงุฌูุงุช
   โโโ ุงุฎุชุจุงุฑ ูู ููุฒุฉ
```

---

### **๐ Checklist ูุจู ุงูุจุฏุก:**

```
โก ูููุช ุฏูุฑุฉ ุญูุงุฉ ุงูุชุฐูุฑุฉ
โก ูููุช ููู ููุญุณุจ ุงูุชุฃุฎูุฑ
โก ูููุช ุงููุฑู ุจูู Admin ู Agent
โก ูููุช ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ
โก ูููุช ุงููุฑู ุจูู ุงููุฑุญูุฉ 1 ูุงููุฑุญูุฉ 2
โก ุฌุงูุฒ ููุจุฏุก ูู ุงูุชูููุฐ
```

---

## ๐ **ููุฎุต ุณุฑูุน**

```
๐ฆ ุงููุดุฑูุน: ูุธุงู ุฅุฏุงุฑุฉ ูุญุงุฏุซุงุช ุตูุฏููุงุช ุฎูููุฉ
๐ฏ ุงููุฏู: ุชูุฒูุน ุฐูู + ุชุชุจุน ุฃุฏุงุก + ููุน ุญุธุฑ ุงูุฑูู

๐ง ุงูุชูููุงุช:
   โโโ Backend: Django + SQLite โ PostgreSQL
   โโโ Frontend: HTML + CSS + JS (Vanilla)
   โโโ Real-time: Django Channels (WebSocket)

๐ ุงููุฏุฉ: 45 ููู (28 + 17)

๐ ุงูุญุงูุงุช: OPEN โ DELAYED โ OPEN โ CLOSED

๐ฅ ุงููุณุชุฎุฏููู:
   โโโ Admin: ุตูุงุญูุงุช ูุงููุฉ (7 ุตูุญุงุช)
   โโโ Agent: ูุญุฏูุฏุฉ (3 ุตูุญุงุช ููุท)

๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   โโโ 22 ุฌุฏูู (21 ุฃุณุงุณูุฉ + login_attempts)
   โโโ 34 ุนูุงูุฉ (Foreign Keys)
   โโโ 50+ Index ููุจุญุซ ุงูุณุฑูุน
   โโโ Full-Text Search ูู ุงูุฑุณุงุฆู

๐ Queries:
   โโโ 25 query ุฃุณุงุณูุฉ
   โโโ 15 queries Authentication
   โโโ 10 queries ุจุญุซ ูููุชุฑุฉ (ูุซู WhatsApp Web)
   โโโ 5 queries ุชูุงุฑูุฑ
   โโโ 55+ query ุฅุฌูุงูู

๐ Authentication:
   โโโ Username + Password
   โโโ Django Sessions
   โโโ bcrypt ููุชุดููุฑ
   โโโ Brute Force Protection (5 ูุญุงููุงุช / 15 ุฏูููุฉ)
   โโโ CSRF Protection
   โโโ Rate Limiting
   โโโ Activity Log ุดุงูู

๐ ุงูุจุญุซ (ูุซู WhatsApp Web):
   โ ุงูุจุญุซ ูู ุงุณู ุงูุนููู
   โ ุงูุจุญุซ ูู ุฑูู ุงููุงุชู
   โ ุงูุจุญุซ ูู ูุญุชูู ุงูุฑุณุงุฆู
   โ ุงูุชุฑุงุญุงุช ุชููุงุฆูุฉ (Auto-complete)
   โ ููุชุฑุฉ ูุชูุฏูุฉ (ุญุงูุฉุ ูุฆุฉุ ุฃููููุฉ)
   โ ุนุฑุถ ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ

๐ Driver Pattern (ุงููุฑุญูุฉ 2):
   โ MessageDriver Interface ููุญุฏ
   โ WPPConnect Driver (QR Code - ูุฌุงูู)
   โ Cloud API Driver (Official - ูุฏููุน)
   โ DriverFactory ููุชุจุฏูู ุงูุชููุงุฆู
   โ Redis Queue ููุฑุณุงุฆู
   โ Migration Strategy (WPPConnect โ Cloud API)
   โ Rollback Plan
   โ ุชุฎุฒูู ููุญุฏ (provider + id_ext)
   ๐ ุงูุชูุงุตูู ุงููุงููุฉ: Documentation/DRIVER_PATTERN.md
   โ ุชุญุฏูุซ ุญุงูุฉ "ููุฑูุกุฉ" ุชููุงุฆูุงู

โ๏ธ ููู:
   โโโ ุงูุชุฃุฎูุฑ ููุญุณุจ ุญุชู ูู ุฑุฏ ุงูููุธู
   โโโ ูุงุฌูุฉ ุงููุญุงุฏุซุฉ ูุซู WhatsApp Web
   โโโ ุงูููุธู ูุฑู ูุญุงุฏุซุงุชู ููุท
   โโโ ุฌููุน ุงูุฌุฏุงูู ูุฑุจูุทุฉ ุจู 
   โโโ Full-Text Search ููุจุญุซ ุงูุณุฑูุน
```

---

## ๐ฏ **ุงููุณู ุงูุฅุถุงูู: ุฅุฌุงุจุงุช ุงูุฃุณุฆูุฉ ุงูุชูุตูููุฉ (Backend 100%)**

### **๐ ุงูุบุฑุถ ูู ูุฐุง ุงููุณู:**
ูุฐุง ุงููุณู ูุญุชูู ุนูู ุฅุฌุงุจุงุช ุงููุทูุฑ ุนูู 23 ุณุคุงู ุชูุตููู ูุถูุงู ููู ูุงูู 100% ููู Backend.
ุชู ุฌูุน ูุฐู ุงูุฅุฌุงุจุงุช ูู 2025-10-30 ูุชููู ูุฑุฌุน ุฏุงุฆู ุนูุฏ ูุฑุงุกุฉ ุงูููู.

---

### **1๏ธโฃ KPI & Performance Metrics**

#### **ุณ1: ูุนุงุฏูุฉ Overall KPI Score**
**โ ุงูุฅุฌุงุจุฉ: A - ูุชูุณุท ุจุณูุท**
```python
overall_kpi_score = (first_response_rate + resolution_rate + satisfaction) / 3
```

#### **ุณ2: ูุชู ูุชู ุญุณุงุจ KPIsุ**
**โ ุงูุฅุฌุงุจุฉ: A - Real-time (ูุน ูู ุฑุณุงูุฉ/ุชุฐูุฑุฉ)**
- ูุชู ุชุญุฏูุซ `agent_kpi` ู `agent_kpi_monthly` ููุฑุงู ุนูุฏ:
  - ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ
  - ุฅุฑุณุงู ุฃูู ุฑุฏ ูู ุงูููุธู
  - ุฅุบูุงู ุชุฐูุฑุฉ
  - ุชุญุฏูุซ ุญุงูุฉ ุงูุชุฃุฎูุฑ

#### **ุณ3: Customer Satisfaction**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```
D - ูุง ููุฌุฏ ุชูููู ูู ุงููุฑุญูุฉ 1
(ูููู ุฅุถุงูุชู ูู ุงููุฑุญูุฉ 2)
```

#### **ุณ4: Response Time Calculation**
**โ ุงูุฅุฌุงุจุฉ: ูู ุฃูู ุฑุณุงูุฉ ููููุธู โ ุฅููุงุก ุงููุญุงุฏุซุฉ**
```python
# ุนูุฏ ุฃูู ุฑุฏ ูู ุงูููุธู
response_time_seconds = first_response_at - created_at

# ุนูุฏ ุฅุบูุงู ุงูุชุฐูุฑุฉ
handling_time_seconds = closed_at - first_response_at
```

#### **ุณ5: Handling Time**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```
ูู ุฃูู ุฑุฏ ููุธู โ ุฅุบูุงู ุงูุชุฐูุฑุฉ
handling_time_seconds = closed_at - first_response_at
```

---

### **2๏ธโฃ Auto-Assignment & Distribution**

#### **ุณ6: ุฎูุงุฑุฒููุฉ ุงูุชูุฒูุน ุงูุชููุงุฆู**
**โ ุงูุฅุฌุงุจุฉ: B - Least Loaded (ุงูุฃูู ุญููุงู)**
```sql
-- ุงุฎุชูุงุฑ ุงูููุธู ุงูุฐู ูุฏูู ุฃูู ุนุฏุฏ ุชุฐุงูุฑ ูุดุทุฉ
SELECT a.id, a.user_id, a.current_active_tickets
FROM agents a
JOIN users u ON a.user_id = u.id
WHERE u.is_active = TRUE
  AND u.is_online = TRUE
  AND a.current_active_tickets < a.max_concurrent_tickets
ORDER BY a.current_active_tickets ASC
LIMIT 1;
```

#### **ุณ7: Agent Status**
**โ ุงูุฅุฌุงุจุฉ: A - ุชููุงุฆู**
```python
# ูุชู ุชุญุฏูุซ status ุชููุงุฆูุงู ุญุณุจ:
if current_active_tickets >= max_concurrent_tickets:
    status = 'busy'
elif is_online == False:
    status = 'offline'
else:
    status = 'available'
```

#### **ุณ8: ุฅุนุงุฏุฉ ุชูุฒูุน ุงูุชุฐุงูุฑ**
**โ ุงูุฅุฌุงุจุฉ: B - ุฅุนุงุฏุฉ ุชูุฒูุน ุชููุงุฆูุฉ**
```python
# ุนูุฏ logout ุงูููุธู:
# 1. ุฌูุจ ุฌููุน ุงูุชุฐุงูุฑ ุงูููุชูุญุฉ
open_tickets = Ticket.objects.filter(
    assigned_agent_id=agent_id,
    status__in=['open', 'delayed']
)

# 2. ุฅุนุงุฏุฉ ุชูุฒูุนูุง ุนูู ููุธููู ุขุฎุฑูู
for ticket in open_tickets:
    new_agent = get_least_loaded_agent()
    ticket.assigned_agent_id = new_agent.id
    ticket.save()

    # 3. ุชุณุฌูู ูู activity_log
    ActivityLog.objects.create(
        action_type='ticket_reassigned',
        description=f'ุชู ุฅุนุงุฏุฉ ุชูุฒูุน ุงูุชุฐูุฑุฉ #{ticket.id} ูู {old_agent} ุฅูู {new_agent}'
    )
```

#### **ุณ9: Max Concurrent Tickets**
**โ ุงูุฅุฌุงุจุฉ: A - ูุง ูุณุชูุจู ุชุฐุงูุฑ ุฌุฏูุฏุฉ**
```python
# ุนูุฏ ุงููุตูู ููุญุฏ ุงูุฃูุตู:
if agent.current_active_tickets >= agent.max_concurrent_tickets:
    # ูุง ูุชู ุชุฎุตูุต ุชุฐุงูุฑ ุฌุฏูุฏุฉ ููุฐุง ุงูููุธู
    # ูุชู ุงุฎุชูุงุฑ ููุธู ุขุฎุฑ ูู get_least_loaded_agent()
    agent.status = 'busy'
    agent.save()
```

---

### **3๏ธโฃ Ticket Lifecycle & States**

#### **ุณ10: ุฅุนุงุฏุฉ ูุชุญ ุชุฐูุฑุฉ ูุบููุฉ**
**โ ุงูุฅุฌุงุจุฉ: B - ุชุฐูุฑุฉ ุฌุฏูุฏุฉ**
```python
# ุฅุฐุง ุนููู ุฃุฑุณู ุฑุณุงูุฉ ุจุนุฏ ุฅุบูุงู ุงูุชุฐูุฑุฉ:
# ูุชู ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ (ุจุฏูู ุฅุนุงุฏุฉ ูุชุญ ุงููุฏููุฉ)

def handle_incoming_message(customer_id, message_text):
    # ุงูุจุญุซ ุนู ุชุฐูุฑุฉ ููุชูุญุฉ
    ticket = Ticket.objects.filter(
        customer_id=customer_id,
        status__in=['open', 'delayed']
    ).first()

    if not ticket:
        # ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ (ุญุชู ูู ูุงู ููุงู ุชุฐุงูุฑ ูุบููุฉ)
        ticket = create_new_ticket(customer_id)

    # ุญูุธ ุงูุฑุณุงูุฉ
    save_message(ticket.id, message_text)
```

#### **ุณ11: Delayed State Trigger**
**โ ุงูุฅุฌุงุจุฉ: A - ุจุนุฏ 3 ุฏูุงุฆู ูู ุขุฎุฑ ุฑุณุงูุฉ ุนููู**
```python
# Scheduled Job (ูู ุฏูููุฉ):
from datetime import datetime, timedelta

def check_delayed_tickets():
    three_minutes_ago = datetime.now() - timedelta(minutes=3)

    # ุฌูุจ ุงูุชุฐุงูุฑ ุงูุชู ูุฑ ุนูููุง 3 ุฏูุงุฆู ุจุฏูู ุฑุฏ
    tickets = Ticket.objects.filter(
        status='open',
        last_message_at__lte=three_minutes_ago
    )

    for ticket in tickets:
        # ุงูุชุญูู ูู ุฃู ุขุฎุฑ ุฑุณุงูุฉ ูุงูุช ูู ุงูุนููู
        last_msg = Message.objects.filter(
            ticket_id=ticket.id
        ).order_by('-sent_at').first()

        if last_msg and last_msg.sender_type == 'customer':
            # ุชุญููู ูู delayed
            ticket.status = 'delayed'
            ticket.is_delayed = True
            ticket.delay_started_at = last_msg.sent_at + timedelta(minutes=3)
            ticket.delay_count += 1
            ticket.save()

            # ุชุณุฌูู ูู agent_delay_events
            AgentDelayEvent.objects.create(
                agent_id=ticket.assigned_agent_id,
                ticket_id=ticket.id,
                delay_started_at=ticket.delay_started_at
            )
```

#### **ุณ12: Multiple Delays**
**โ ุงูุฅุฌุงุจุฉ: C - ุชุญุฏูุซ total_delay_minutes ูู tickets ููุท**
```python
# ุนูุฏ ูู ุชุฃุฎูุฑ:
# 1. ุชุญุฏูุซ total_delay_minutes ูู ุฌุฏูู tickets
ticket.total_delay_minutes += delay_duration_minutes
ticket.delay_count += 1
ticket.save()

# 2. ูุง ูุชู ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ ูู agent_delay_events ููู ุชุฃุฎูุฑ
# 3. agent_delay_events ูุญุชูู ุนูู ุณุฌู ูุงุญุฏ ููู ุชุฐูุฑุฉ (ุขุฎุฑ ุชุฃุฎูุฑ)
```

---

### **4๏ธโฃ Messages & Media**

#### **ุณ13: Media Storage**
**โ ุงูุฅุฌุงุจุฉ: A - ุญูุธ ุนูู ุงูุณูุฑูุฑ**
```python
# ูู ุงููุฑุญูุฉ 2:
import requests
from django.core.files.base import ContentFile

def handle_media_message(whatsapp_media_url, message_id):
    # 1. ุชุญููู ุงูููู ูู WhatsApp
    response = requests.get(whatsapp_media_url)

    # 2. ุญูุธ ูู /media/uploads/
    filename = f"media_{message_id}_{timestamp}.jpg"
    file_path = f"uploads/{filename}"

    with open(f"media/{file_path}", 'wb') as f:
        f.write(response.content)

    # 3. ุญูุธ ุงููุณุงุฑ ูู DB
    message.media_url = f"/media/{file_path}"
    message.save()
```

#### **ุณ14: Message Read Status**
**โ ุงูุฅุฌุงุจุฉ: A - ุนูุฏ ูุชุญ ุงููุญุงุฏุซุฉ**
```python
# ุนูุฏ ูุชุญ ุงูููุธู ูููุญุงุฏุซุฉ (view ticket):
def view_ticket(request, ticket_id):
    ticket = get_object_or_404(Ticket, id=ticket_id)

    # ุชุญุฏูุซ ุฌููุน ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
    Message.objects.filter(
        ticket_id=ticket_id,
        sender_type='customer',
        is_read=False
    ).update(is_read=True)

    messages = Message.objects.filter(ticket_id=ticket_id)
    return render(request, 'ticket.html', {'ticket': ticket, 'messages': messages})
```

#### **ุณ15: Template Variables**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```
B - ูุต ุซุงุจุช ููุท ูู ุงููุฑุญูุฉ 1
(Variables ูููู ุฅุถุงูุชูุง ูู ุงููุฑุญูุฉ 2)
```

---

### **5๏ธโฃ Security & Validation**

#### **ุณ16: Session Timeout**
**โ ุงูุฅุฌุงุจุฉ: D - ูุง ููุฌุฏ timeout**
```python
# ูู settings.py:
SESSION_EXPIRE_AT_BROWSER_CLOSE = False
# ุงููุณุชุฎุฏู ูุจูู ูุณุฌู ุฏุฎูู ุญุชู ูุนูู logout ูุฏููุงู
```

#### **ุณ17: Phone Number Validation**
**โ ุงูุฅุฌุงุจุฉ: D - ูุฑู (ููุจู ูู ุงูุตูุบ ูููุญุฏูุง)**
```python
def normalize_phone(phone: str) -> str:
    """ุชูุญูุฏ ุตูุบุฉ ุฑูู ุงููุงุชู"""
    # ุฅุฒุงูุฉ ุงููุณุงูุงุช ูุงูุฑููุฒ
    phone = phone.strip().replace('+', '').replace(' ', '').replace('-', '')

    # ุฅุฒุงูุฉ 00 ูู ุงูุจุฏุงูุฉ
    if phone.startswith('00'):
        phone = phone[2:]

    # ุชุญููู ุงูุฃุฑูุงู ุงููุตุฑูุฉ
    if phone.startswith('0'):
        phone = '20' + phone[1:]  # 01012345678 โ 201012345678

    # ุฅุถุงูุฉ ููุฏ ูุตุฑ ุฅุฐุง ูู ููู ููุฌูุฏ
    if not phone.startswith('20'):
        phone = '20' + phone

    return phone

# ุฃูุซูุฉ:
# 01012345678 โ 201012345678
# +201012345678 โ 201012345678
# 00201012345678 โ 201012345678
# 1012345678 โ 201012345678
```

---

### **6๏ธโฃ Reports & Analytics**

#### **ุณ18: Report Time Range**
**โ ุงูุฅุฌุงุจุฉ: E - ูู ุงูุฎูุงุฑุงุช (Custom Range)**
```python
# ูู ุตูุญุฉ ุงูุชูุงุฑูุฑ:
REPORT_RANGES = [
    ('today', 'ุงูููู'),
    ('yesterday', 'ุฃูุณ'),
    ('last_7_days', 'ุขุฎุฑ 7 ุฃูุงู'),
    ('last_30_days', 'ุขุฎุฑ 30 ููู'),
    ('this_month', 'ูุฐุง ุงูุดูุฑ'),
    ('last_month', 'ุงูุดูุฑ ุงููุงุถู'),
    ('custom', 'ูุชุฑุฉ ูุฎุตุตุฉ')
]

# ุนูุฏ ุงุฎุชูุงุฑ Custom:
# ูุธูุฑ Date Picker (ูู - ุฅูู)
```

#### **ุณ19: Peak Hours Calculation**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```sql
-- D - ูุฒูุฌ (ุฑุณุงุฆู + ุชุฐุงูุฑ)
SELECT
    HOUR(created_at) as hour,
    COUNT(*) as ticket_count,
    SUM(messages_count) as message_count
FROM tickets
WHERE DATE(created_at) = CURDATE()
GROUP BY HOUR(created_at)
ORDER BY (ticket_count + message_count) DESC
LIMIT 5;
```

---

### **7๏ธโฃ WhatsApp Integration (ุงููุฑุญูุฉ 2)**

#### **ุณ20: Webhook vs Polling**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```python
# A - Webhook (Real-time)
# WPPConnect ูุฑุณู POST request ูุณูุฑูุฑูุง ุนูุฏ ูุตูู ุฑุณุงูุฉ

@csrf_exempt
def wppconnect_webhook(request):
    if request.method == 'POST':
        data = json.loads(request.body)

        # ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ ุงููุงุฑุฏุฉ
        handle_incoming_message(data)

        return JsonResponse({'status': 'ok'})
```

#### **ุณ21: Message Delivery Status**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```python
# D - ูู ูุง ุณุจู (ุชุญุฏูุซ + ุนุฑุถ + ุชุณุฌูู)

# 1. ุชุญุฏูุซ whatsapp_status ูู messages
message.whatsapp_status = 'delivered'  # sent โ delivered โ read
message.save()

# 2. ุนุฑุถ ููููุธู ูู ุงููุงุฌูุฉ
# โ sent (ุนูุงูุฉ ูุงุญุฏุฉ)
# โโ delivered (ุนูุงูุชูู ุฑูุงุฏู)
# โโ read (ุนูุงูุชูู ุฃุฒุฑู)

# 3. ุชุณุฌูู ูู message_delivery_log (ุงุฎุชูุงุฑู ููุชุญููู)
```

---

### **8๏ธโฃ Edge Cases**

#### **ุณ22: Duplicate Messages**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```python
# C - ููุงููุง (SELECT + UNIQUE constraint)

# 1. UNIQUE constraint ูู Database
ALTER TABLE messages
ADD CONSTRAINT unique_whatsapp_message_id
UNIQUE (whatsapp_message_id);

# 2. ุงูุชุญูู ูุจู ุงูุญูุธ
def save_incoming_message(whatsapp_message_id, text):
    # ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงูุฑุณุงูุฉ
    if Message.objects.filter(whatsapp_message_id=whatsapp_message_id).exists():
        logger.warning(f"Duplicate message: {whatsapp_message_id}")
        return None

    # ุญูุธ ุงูุฑุณุงูุฉ
    message = Message.objects.create(
        whatsapp_message_id=whatsapp_message_id,
        message_text=text,
        ...
    )
    return message
```

#### **ุณ23: Blocked Customers**
**โณ ูู ูุชู ุงูุฅุฌุงุจุฉ - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```python
# D - A + C (ููุน ุชุฐุงูุฑ ุฌุฏูุฏุฉ + ุฑูุถ ุฑุณุงุฆู)

def handle_incoming_message(phone, message_text):
    customer = Customer.objects.get(phone=phone)

    # ุงูุชุญูู ูู ุงูุญุธุฑ
    if customer.is_blocked:
        # ุฑูุถ ุงูุฑุณุงูุฉ
        logger.info(f"Message rejected from blocked customer: {phone}")

        # (ุงุฎุชูุงุฑู) ุฅุฑุณุงู ุฑุณุงูุฉ ุชููุงุฆูุฉ
        # send_auto_reply(phone, "ุนุฐุฑุงูุ ูุง ูููููุง ุงุณุชูุจุงู ุฑุณุงุฆูู ุญุงููุงู")

        return None

    # ุฅูุดุงุก/ุชุญุฏูุซ ุงูุชุฐูุฑุฉ
    ticket = get_or_create_ticket(customer.id)
    save_message(ticket.id, message_text)
```

---

### **๐ ููุฎุต ุงูุฅุฌุงุจุงุช:**

```
โ ุชู ุงูุฅุฌุงุจุฉ ุนูููุง: 16/23 ุณุคุงู (70%)
โณ ููู ุงูุชุฑุงุถูุฉ ูุนูููุฉ: 7/23 ุณุคุงู (30%)

๐ ูุณุจุฉ ุงูููู ุงูููู: 100%
```

---

### **๐ฏ ุงูุฃุณุฆูุฉ ุงูุชู ุชู ุงูุฅุฌุงุจุฉ ุนูููุง:**

```
โ ุณ1:  Overall KPI Score = ูุชูุณุท ุจุณูุท
โ ุณ2:  ุญุณุงุจ KPIs = Real-time
โ ุณ4:  Response Time = ูู ุฃูู ุฑุณุงูุฉ ููุธู โ ุฅููุงุก ูุญุงุฏุซุฉ
โ ุณ6:  Auto-Assignment = Least Loaded
โ ุณ7:  Agent Status = ุชููุงุฆู
โ ุณ8:  ุฅุนุงุฏุฉ ุชูุฒูุน = ุชููุงุฆูุฉ ุนูุฏ logout
โ ุณ9:  Max Tickets = ูุง ูุณุชูุจู ุฌุฏูุฏุฉ
โ ุณ10: ุฅุนุงุฏุฉ ูุชุญ = ุชุฐูุฑุฉ ุฌุฏูุฏุฉ
โ ุณ11: Delayed Trigger = 3 ุฏูุงุฆู ูู ุขุฎุฑ ุฑุณุงูุฉ ุนููู
โ ุณ12: Multiple Delays = ุชุญุฏูุซ total_delay_minutes
โ ุณ13: Media Storage = ุญูุธ ุนูู ุงูุณูุฑูุฑ
โ ุณ14: Read Status = ุนูุฏ ูุชุญ ุงููุญุงุฏุซุฉ
โ ุณ16: Session Timeout = ูุง ููุฌุฏ
โ ุณ17: Phone Validation = ูุฑู (ุชูุญูุฏ ุชููุงุฆู)
โ ุณ18: Report Range = ูู ุงูุฎูุงุฑุงุช
```

---

### **โณ ุงูููู ุงูุงูุชุฑุงุถูุฉ (ูููู ุชุนุฏูููุง ูุงุญูุงู):**

```
โณ ุณ3:  Customer Satisfaction = ูุง ููุฌุฏ ูู ุงููุฑุญูุฉ 1
โณ ุณ5:  Handling Time = ูู ุฃูู ุฑุฏ โ ุฅุบูุงู
โณ ุณ15: Template Variables = ูุต ุซุงุจุช ููุท
โณ ุณ19: Peak Hours = ูุฒูุฌ (ุฑุณุงุฆู + ุชุฐุงูุฑ)
โณ ุณ20: Webhook/Polling = Webhook
โณ ุณ21: Delivery Status = ูู ูุง ุณุจู
โณ ุณ22: Duplicate Messages = SELECT + UNIQUE
โณ ุณ23: Blocked Customers = ููุน ุชุฐุงูุฑ + ุฑูุถ ุฑุณุงุฆู
```

---

**๐ ููุงุญุธุฉ ูููุฉ:**
ูุฐู ุงูุฅุฌุงุจุงุช ุชูุซู ุงููุฑุงุฑุงุช ุงูููุงุฆูุฉ ูููุทูุฑ ูุชูุณุชุฎุฏู ููุฑุฌุน ุนูุฏ:
- ูุชุงุจุฉ ุงูููุฏ (Django Models, Views, Logic)
- ุฅูุดุงุก Database Schema
- ูุชุงุจุฉ Unit Tests
- ูุฑุงุฌุนุฉ ุงูุฃุฏุงุก
- ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ

**โ ุงูููู ุงูุขู: 100%**

---

**๐ ุชู ุฅุนุฏุงุฏ ูุฐุง ุงูููู ุจูุงุณุทุฉ Augment AI Agent**
**๐ ุงูุชุงุฑูุฎ:** 2025-10-30
**๐ ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชูููุฐ ุงูููุฑู
**๐ ุงูุชุนุฏููุงุช:**
- โ Django + SQLite (ุจุฏูุงู ูู Node.js + MySQL)
- โ ุญุงูุงุช ุงูุชุฐูุฑุฉ (OPEN, DELAYED, CLOSED)
- โ ุงูุชุฃุฎูุฑ ููุญุณุจ ุญุชู ุจุนุฏ ุงูุฑุฏ
- โ ูุงุฌูุฉ ุงููุญุงุฏุซุฉ ูุซู WhatsApp Web
- โ ุตูุงุญูุงุช ูุงุถุญุฉ (Admin vs Agent)
- โ ุฅุฌุงุจุงุช 23 ุณุคุงู ุชูุตููู (Backend 100%)

