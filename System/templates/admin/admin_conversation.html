{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Conversation with" %} {{ customer.name }}{% endblock %}
{% block page_title %}{% trans "Conversation with" %} {{ customer.name }} ({{ user.get_role_display }} {% trans "Mode" %}){% endblock %}

{% block extra_css %}
<style>
<!-- Version: 20251111-1645 - Force browser refresh -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    /* Admin Conversation Styles */
    .admin-notice {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .chat-container {
        height: calc(100vh - 250px);
        background: #f0f2f5;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Chat Header */
    .chat-header {
        background: white;
        padding: 15px 20px;
        border-bottom: 1px solid #e9edef;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-header-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 600;
    }

    /* Messages Area */
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23efeae2" width="100" height="100"/></svg>');
        display: flex;
        flex-direction: column;
    }

    .message-bubble {
        max-width: 65%;
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
    }

    .message-bubble.customer {
        align-self: flex-end;
        align-items: flex-end;
    }

    .message-bubble.agent {
        align-self: flex-start;
        align-items: flex-start;
    }

    .message-content {
        padding: 8px 12px;
        border-radius: 8px;
        position: relative;
        word-wrap: break-word;
    }

    .message-bubble.customer .message-content {
        background: white;
        border-radius: 8px 0 8px 8px;
    }

    .message-bubble.agent .message-content {
        background: #d9fdd3;
        border-radius: 0 8px 8px 8px;
    }

    .message-text {
        font-size: 14px;
        color: #111b21;
        margin: 0;
        line-height: 1.5;
    }

    .message-meta {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 4px;
    }
    
    .message-bubble.customer .message-meta {
        justify-content: flex-end;
    }
    
    .message-bubble.agent .message-meta {
        justify-content: flex-start;
    }

    .message-time {
        font-size: 11px;
        color: #667781;
    }

    .message-sender {
        font-size: 11px;
        color: #25d366;
        font-weight: 500;
    }

    /* Message Input */
    .message-input-container {
        background: #f0f2f5;
        padding: 10px 20px;
        border-top: 1px solid #e9edef;
    }

    .message-input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .message-input-box {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 10px 15px;
        border: none;
        font-size: 15px;
        resize: none;
        max-height: 100px;
    }

    .send-button {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        background: #25d366;
        color: white;
        cursor: pointer;
    }

    .send-button:hover {
        background: #20bd5a;
    }
</style>
{% endblock %}

{% block content %}

<!-- Admin Notice -->
<div class="admin-notice">
    <i class="fas fa-user-shield"></i> {% trans "You are acting as a" %} {{ user.get_role_display }} {% trans "in this conversation with" %} {{ customer.name }}
</div>

<!-- Chat Container -->
<div class="chat-container">
    
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="chat-header-info">
            <div class="chat-avatar">{{ customer.name|slice:":1"|upper }}</div>
            <div>
                <div class="fw-bold">{{ customer.name }}</div>
                <div class="text-muted small">{{ customer.phone_number }}</div>
            </div>
        </div>
        <div>
            <span class="badge bg-info">{% trans "Ticket #" %}{{ ticket.id }}</span>
            {% if ticket.is_delayed %}
            <span class="badge bg-danger">{% trans "Delayed" %}</span>
            {% endif %}
        </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" id="messagesContainer">
        <!-- Messages will be loaded here -->
    </div>

    <!-- Message Input -->
    <div class="message-input-container">
        <form onsubmit="sendMessage(event)" class="message-input-wrapper">
            <textarea
                class="message-input-box"
                id="messageText"
                placeholder="{% trans 'Type a message...' %}"
                rows="1"
                onkeypress="handleKeyPress(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button type="submit" class="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
    const currentTicketId = {{ ticket.id }};
    const currentCustomerId = {{ customer.id }};
    let messagesPolling = null;

    // Load messages on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadMessages();
        // Start polling for new messages
        messagesPolling = setInterval(loadMessages, 5000);
    });

    // Load messages
    async function loadMessages() {
        try {
            const response = await fetch(`/api/customers/${currentCustomerId}/messages/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'same-origin'
            });
            const data = await response.json();
            
            // Handle both response formats
            const messages = data.results || data.messages || [];
            const container = document.getElementById('messagesContainer');
            const previousScrollHeight = container.scrollHeight;
            const wasAtBottom = container.scrollTop + container.clientHeight >= previousScrollHeight - 50;
            
            container.innerHTML = '';

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                
                // Ensure proper message alignment based on sender_type
                if (message.sender_type === 'customer') {
                    messageDiv.className = 'message-bubble customer';
                } else if (message.sender_type === 'agent' || message.sender_type === 'admin') {
                    messageDiv.className = 'message-bubble agent';
                } else {
                    // Default to customer if sender_type is undefined or unexpected
                    messageDiv.className = 'message-bubble customer';
                }

                let contentHtml = `
                    <div class="message-content">
                        <p class="message-text">${escapeHtml(message.message_text || '')}</p>
                        <div class="message-meta">
                            ${message.sender_type === 'agent' && message.sender_name ? `<span class="message-sender">${message.sender_name}</span> â€¢ ` : ''}
                            <span class="message-time">${formatTime(message.created_at)}</span>
                        </div>
                    </div>
                `;

                messageDiv.innerHTML = contentHtml;
                container.appendChild(messageDiv);
            });

            // Scroll to bottom if was at bottom
            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }

        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    // Send message
    async function sendMessage(event) {
        event.preventDefault();

        const messageText = document.getElementById('messageText');
        const content = messageText.value.trim();

        if (!content || !currentTicketId) return;

        try {
            const response = await fetch('/api/whatsapp/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': khalifaPharmacy.getCookie('csrftoken')
                },
                body: JSON.stringify({
                    ticket_id: currentTicketId,
                    message: content
                })
            });

            if (response.ok) {
                messageText.value = '';
                messageText.style.height = 'auto';
                await loadMessages();
            } else {
                const error = await response.json();
                khalifaPharmacy.showToast(error.error || '{% trans "Failed to send message" %}', 'error');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            khalifaPharmacy.showToast('{% trans "Error sending message" %}', 'error');
        }
    }

    // Handle Enter key
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage(event);
        }
    }

    // Auto resize textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    // Escape HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Format time
    function formatTime(dateString) {
        const date = new Date(dateString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (messagesPolling) {
            clearInterval(messagesPolling);
        }
    });
</script>
{% endblock %}